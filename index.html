<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & Visualization Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Data & Stat Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.5/dist/jstat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
    
    <!-- Chosen Palette: Minimalist White & Blue -->
    <style>
        :root {
            --fb-blue: #1877F2;
            --fb-blue-dark: #166FE5;
        }
        body {
            background-color: #FFFFFF; /* White */
            color: #1f2937; /* gray-800 */
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active {
            background-color: var(--fb-blue);
            color: #FFFFFF;
            font-weight: 600;
            border-color: var(--fb-blue);
        }
        .test-card {
            background-color: #FFFFFF;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #e5e7eb; /* gray-200 */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(24, 119, 242, 0.1), 0 4px 6px -2px rgba(24, 119, 242, 0.05);
        }
        details > summary {
            cursor: pointer;
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        pre {
            background-color: #f3f4f6; /* gray-100 */
            color: #111827; /* gray-900 */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
        }
        .custom-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
         #analysis-output.loading::after {
            content: '..';
            display: inline-block;
            animation: loading-dots 1s infinite steps(3, start);
        }
        @keyframes loading-dots {
            0% { content: '..'; }
            33% { content: '...'; }
            66% { content: '....'; }
        }
    </style>
</head>
<body class="antialiased font-sans">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold" style="color: #1877F2;">Analytics & Visualization Tool</h1>
            <p class="text-lg text-gray-600 mt-2">A comprehensive reference for statistical analysis in Python for quantitative psychological research.</p>
        </header>

        <div class="flex flex-col md:flex-row gap-8 lg:gap-12">
            <aside class="md:w-1/4 lg:w-1/5">
                <div class="sticky top-8 bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200 max-h-[calc(100vh-4rem)] overflow-y-auto">

                    <h3 class="text-lg font-semibold mb-4 border-b border-gray-200 pb-2" style="color: #1877F2;">Analysis & Visualization</h3>
                    <div class="flex flex-col space-y-2 mb-6">
                        <button data-filter="automation" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Data Analysis</button>
                        <button data-filter="visualization" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Data Visualization</button>
                    </div>

                    <h3 class="text-lg font-semibold mb-4 border-b border-gray-200 pb-2" style="color: #1877F2;">Data Upload</h3>
                    <div class="flex flex-col space-y-2 mb-6">
                        <button data-filter="data-python" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Data Upload Guides</button>
                    </div>

                    <h3 class="text-lg font-semibold mb-4 border-b border-gray-200 pb-2" style="color: #1877F2;">Statistical Tests</h3>
                    <div class="relative mb-2">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <svg class="w-5 h-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                        </span>
                        <input type="text" id="search-input" placeholder="Search tests..." class="w-full pl-10 pr-4 py-2 rounded-md bg-white border border-gray-300 focus:bg-white focus:border-blue-500 focus:ring-0 text-gray-800 placeholder-gray-400">
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button data-filter="descriptive" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Descriptive & Assumptions</button>
                        <button data-filter="comparison" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Compare Means</button>
                        <button data-filter="association" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Association & Correlation</button>
                        <button data-filter="prediction" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Prediction</button>
                        <button data-filter="nonparametric" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Non-Parametric</button>
                        <button data-filter="advanced" class="filter-btn w-full text-left px-4 py-2 rounded-md bg-white border border-gray-300 hover:bg-gray-100">Advanced Multivariate</button>
                    </div>
                </div>
            </aside>

            <main id="test-grid" class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="test-card bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2" data-category="automation">
                    <h2 class="text-2xl font-bold mb-3" style="color: #1877F2;">Data Analysis Tool</h2>
                    <p class="text-gray-800 mb-4 font-semibold leading-relaxed">Purpose: Upload your data, select your variables and the desired test, and get statistical output instantly.</p>
            
                    <!-- Step 1: Upload Data -->
                    <div class="mb-6">
                        <label for="fileInput" class="block mb-2 text-sm font-medium text-gray-700">1. Upload your data (CSV or Excel)</label>
                        <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                    </div>
            
                    <!-- This section will be hidden until a file is loaded -->
                    <div id="analysis-controls" class="hidden">
                        <!-- Data Preview -->
                        <div id="data-preview-container" class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-2">Data Preview:</h4>
                            <div class="overflow-x-auto bg-gray-50 p-2 rounded max-h-48 border border-gray-200">
                                <table id="preview-table" class="min-w-full text-sm text-left text-gray-700">
                                    <!-- JS will populate this -->
                                </table>
                            </div>
                        </div>

                        <!-- Recommendation Section -->
                        <div id="analysis-recommendation-container" class="mb-6 hidden">
                            <h4 class="font-semibold text-gray-800 mb-2">Recommended Statistical Test:</h4>
                            <div id="analysis-recommendation" class="bg-blue-50 p-3 rounded border border-blue-200 text-gray-700 text-sm">
                                <!-- JS will populate this -->
                            </div>
                        </div>
            
                        <!-- Step 2: Select Test -->
                        <div class="mb-6">
                            <label for="test-selector" class="block mb-2 text-sm font-medium text-gray-700">2. Select a Statistical Test</label>
                            <select id="test-selector" class="custom-select bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option selected disabled value="">Choose a test...</option>
                                <optgroup label="Descriptive & Assumptions">
                                    <option value="descriptive">Descriptive Statistics</option>
                                    <option value="shapiro">Normality Test (Skew & Kurtosis)</option>
                                    <option value="levene">Levene's Test</option>
                                    <option value="cronbach_alpha">Cronbach's Alpha (Reliability)</option>
                                </optgroup>
                                <optgroup label="Compare Means (Parametric)">
                                    <option value="ttest_ind">Independent Samples t-test</option>
                                    <option value="ttest_rel">Paired Samples t-test</option>
                                    <option value="anova_one_way">One-Way ANOVA</option>
                                    <option value="factorial_anova">Factorial ANOVA</option>
                                </optgroup>
                                 <optgroup label="Compare Means (Non-Parametric)">
                                    <option value="mann_whitney">Mann-Whitney U Test</option>
                                    <option value="wilcoxon">Wilcoxon Signed-Rank Test</option>
                                    <option value="kruskal_wallis">Kruskal-Wallis H Test</option>
                                </optgroup>
                                <optgroup label="Association & Correlation">
                                    <option value="pearson">Pearson Correlation</option>
                                    <option value="spearman">Spearman Correlation</option>
                                    <option value="chi_square">Chi-Square Test</option>
                                </optgroup>
                                 <optgroup label="Prediction">
                                    <option value="simple_regression">Simple Linear Regression</option>
                                    <option value="multiple_regression">Multiple Linear Regression</option>
                                    <option value="logistic_regression">Logistic Regression</option>
                                    <option value="moderation">Moderation Analysis</option>
                                </optgroup>
                            </select>
                        </div>
            
                        <!-- Step 3: Select Columns (Dynamic) -->
                        <div id="column-selector-container" class="mb-6">
                            <!-- JS will inject column selectors here -->
                        </div>
            
                        <!-- Step 4: Run -->
                        <button id="run-analysis-btn" disabled class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                            Run Analysis
                        </button>
                    </div>
            
                    <!-- Step 5: Results -->
                    <div class="mt-6">
                        <h4 class="font-semibold text-gray-800 mb-2">Results:</h4>
                    <div id="analysis-output" class="bg-gray-50 p-4 rounded text-gray-700 min-h-[100px] border border-gray-200"></div>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2" data-category="visualization">
                    <h2 class="text-2xl font-bold mb-3" style="color: #1877F2;">Data Visualization Tool</h2>
                    <p class="text-gray-800 mb-4 font-semibold leading-relaxed">Purpose: Upload your data, select a chart type and variables, and generate insightful visualizations instantly.</p>
                
                    <!-- Step 1: Upload Data -->
                    <div class="mb-6">
                        <label for="visFileInput" class="block mb-2 text-sm font-medium text-gray-700">1. Upload your data (CSV or Excel)</label>
                        <input type="file" id="visFileInput" accept=".csv, .xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                    </div>
                
                    <!-- This section will be hidden until a file is loaded -->
                    <div id="visualization-controls" class="hidden">
                        <!-- Data Preview -->
                        <div id="vis-data-preview-container" class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-2">Data Preview:</h4>
                            <div class="overflow-x-auto bg-gray-50 p-2 rounded max-h-48 border border-gray-200">
                                <table id="vis-preview-table" class="min-w-full text-sm text-left text-gray-700">
                                    <!-- JS will populate this -->
                                </table>
                            </div>
                        </div>

                        <!-- Recommendation Section -->
                        <div id="vis-recommendation-container" class="mb-6 hidden">
                            <h4 class="font-semibold text-gray-800 mb-2">Chart Recommendations:</h4>
                            <div id="vis-recommendation" class="bg-blue-50 p-3 rounded border border-blue-200 text-gray-700 text-sm">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                
                        <!-- Step 2: Select Chart Type -->
                        <div class="mb-6">
                            <label for="chart-selector" class="block mb-2 text-sm font-medium text-gray-700">2. Select a Visualization Type</label>
                            <select id="chart-selector" class="custom-select bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option selected disabled value="">Choose a chart...</option>
                                <optgroup label="Distributions">
                                    <option value="histogram">Histogram</option>
                                    <option value="density_plot">Density Plot</option>
                                    <option value="boxplot">Box Plot</option>
                                    <option value="violin_plot">Violin Plot</option>
                                    <option value="qq_plot">QQ Plot</option>
                                    <option value="ridgeline_plot">Ridgeline Plot</option>
                                </optgroup>
                                <optgroup label="Relationships &amp; Comparisons">
                                    <option value="scatter_plot">Scatter Plot</option>
                                    <option value="line_chart">Line Chart</option>
                                    <option value="bar_chart">Bar Chart</option>
                                    <option value="area_chart">Area Chart</option>
                                    <option value="bubble_chart">Bubble Chart</option>
                                    <option value="dot_plot">Dot Plot</option>
                                </optgroup>
                                <optgroup label="Correlations &amp; Matrix">
                                    <option value="heatmap">Heatmap</option>
                                    <option value="correlogram">Correlogram</option>
                                </optgroup>
                                <optgroup label="Part-to-Whole &amp; Hierarchical">
                                    <option value="pie_chart">Pie Chart</option>
                                    <option value="pareto_chart">Pareto Chart</option>
                                    <option value="treemap">Treemap</option>
                                    <option value="sunburst_chart">Sunburst Chart</option>
                                    <option value="mosaic_plot">Mosaic Plot</option>
                                </optgroup>
                                <optgroup label="Flow &amp; Networks">
                                    <option value="sankey_diagram">Sankey Diagram</option>
                                    <option value="network_graph">Network Graph</option>
                                    <option value="funnel_chart">Funnel Chart</option>
                                </optgroup>
                                <optgroup label="Specialized &amp; Statistical">
                                    <option value="forest_plot">Forest Plot</option>
                                    <option value="kaplan_meier_curve">Kaplan-Meier Curve</option>
                                    <option value="roc_curve">ROC Curve</option>
                                </optgroup>
                            </select>
                        </div>
                
                        <!-- Step 3: Select Columns (Dynamic) -->
                        <div id="vis-column-selector-container" class="mb-6">
                            <!-- JS will inject column selectors here -->
                        </div>
                
                        <!-- Step 4: Run -->
                        <button id="run-visualization-btn" disabled class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                            Generate Visualization
                        </button>
                    </div>
                
                    <!-- Step 5: Results -->
                    <div class="mt-6">
                        <h4 class="font-semibold text-gray-800 mb-2">Visualization:</h4>
                        <div id="visualization-output" class="bg-gray-50 p-4 rounded text-gray-700 min-h-[400px] border border-gray-200">
                            <p class="text-center pt-16 text-gray-500">Your chart will appear here.</p>
                        </div>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="data-python">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">CSV to Python</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To load data from an existing CSV (Comma-Separated Values) file into a pandas DataFrame, a common task in data analysis.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When your data is in a `.csv` file, a common format exported from programs like Excel or Google Sheets, and you need to analyze it in Python.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">You have a file named `study_results.csv` from your lab containing participant responses, and you want to load it to calculate descriptive statistics.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import pandas as pd
file_path = 'path/to/your/data.csv'
df = pd.read_csv(file_path)
print(df.head())</code></pre>
                            </div>
                        </details>
                    </div>
                </div>
                
                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="data-python">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Excel to Python</h2>
                    <div class="space-y-4">
                         <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To load data from a specific sheet in an Excel workbook (`.xlsx` or `.xls`) into a pandas DataFrame.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When your data is in an Excel file, especially if it has multiple sheets, formulas, or formatting that you want to bypass to get the raw data.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">You have a file `survey_data.xlsx` with sheets for 'Demographics' and 'Responses', and you want to load only the 'Responses' sheet for analysis.</p>
                        </div>
                        <details class="pt-2">
                            <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import pandas as pd
# You may need to run: pip install openpyxl
file_path = 'path/to/your/workbook.xlsx'
# This loads the first sheet by default
df = pd.read_excel(file_path, sheet_name='Sheet1')
print(df.head())</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="data-python">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Dataframe in Python</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To create a pandas DataFrame directly within a Python script using a dictionary, which is ideal for organizing small or manually entered datasets.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">For manually entering small datasets, creating sample data for testing code, or quickly combining lists of data into a structured table format.</p>
                        </div>
                         <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">You need to create a small table of participant demographics (e.g., ID, Age, Group) to test a statistical function before running it on your full dataset.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import pandas as pd
data = {
    'Participant_ID': [1, 2, 3, 4, 5],
    'Age': [25, 31, 22, 45, 38],
    'Score': [88, 92, 95, 78, 85]
}
df = pd.DataFrame(data)
print(df)</code></pre>
                            </div>
                        </details>
                    </div>
                </div>
                
                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="descriptive">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Descriptive Statistics</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To summarize the main features of a dataset, such as central tendency (Mean, Median, Mode) and dispersion (Standard Deviation, Variance, Range).</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">This should be the first step in nearly any quantitative analysis. It helps you understand the basic characteristics of your variables and is essential for reporting your sample demographics.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Calculating the average age, the standard deviation of test scores, and the frequency of participants in each experimental condition before conducting primary analyses.</p>
                        </div>
                        <details class="pt-2">
                            <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import pandas as pd
data = {'score': [88, 92, 80, 89, 95, 85, 78, 90]}
df = pd.DataFrame(data)
print(df['score'].describe())</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="descriptive">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Shapiro-Wilk Test for Normality</h2>
                     <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To formally test whether a sample of data was drawn from a normally distributed (bell-shaped) population.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">Before running parametric tests like a t-test or ANOVA, which assume that the data (or sampling distribution) is normally distributed. A non-significant result (p > .05) is desired.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Checking if the 'reaction_time' data for a group of participants follows a bell curve before using a t-test to compare it to another group.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy import stats
data = [88, 92, 80, 89, 95, 85, 78, 90]
stat, p_value = stats.shapiro(data)
print(f'P-value={p_value:.3f}')</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                 <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="descriptive">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Levene's Test for Homogeneity</h2>
                     <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To test the assumption that two or more groups have equal variances (a measure of data spread).</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">Before running an independent t-test or ANOVA to ensure the groups have a similar spread. A non-significant result (p > .05) is desired, indicating that the assumption is met.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Before comparing the mean test scores of 'treatment' and 'control' groups, you would use Levene's test to verify that the scores in both groups are equally spread out.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy.stats import levene
group1 = [1,2,3,4,5,6,7,8,9,10]
group2 = [2,3,4,5,6,7,8,9,10,11]
stat, p_value = levene(group1, group2)
print(f'P-value={p_value:.3f}')</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="descriptive">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Boxplot</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To visually summarize the distribution of a numerical dataset, showing the median, quartiles, and potential outliers.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">To quickly compare the distributions of a variable across different groups or to visually inspect a single variable for its spread and identify any extreme values (outliers).</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Creating side-by-side boxplots to visually compare the spread and median of exam scores across three different teaching methods.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import matplotlib.pyplot as plt
import pandas as pd
data = {'Group A': [1,2,3,4,5,10], 'Group B': [5,6,7,8,9,20]}
df = pd.DataFrame(data)
df.boxplot()
plt.show()
</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="comparison">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Independent Samples t-test</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To compare the means of a continuous variable between two independent, unrelated groups.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you have one continuous dependent variable (e.g., test score) and one categorical independent variable with exactly two levels (e.g., treatment vs. control group).</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Comparing the average test scores of a control group versus an experimental group to see if a new teaching method was effective.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy import stats
group_a = [7,4,6,8,5,6,7,5,8,9]
group_b = [3,5,2,4,6,4,3,5,2,4]
t_stat, p_value = stats.ttest_ind(group_a, group_b)
print(f"P-value: {p_value}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="comparison">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Paired Samples t-test</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To compare the means of two related groups, such as the same subjects measured at two different points in time.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you have one continuous dependent variable that has been measured on two occasions for the same set of subjects (a within-subjects design).</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Comparing participants' average anxiety scores before and after a therapy intervention to see if the therapy had a significant effect.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy import stats
pre_score = [8,7,6,9,5,7,8,6,7,9]
post_score = [9,8,7,10,6,8,9,7,8,10]
t_stat, p_value = stats.ttest_rel(pre_score, post_score)
print(f"P-value: {p_value}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>
                
                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="comparison">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">One-Way ANOVA</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To compare the means of a continuous variable across three or more independent groups.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you have one continuous dependent variable and one categorical independent variable with three or more levels (groups).</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Comparing the effectiveness of three different therapies (e.g., CBT, Psychoanalytic, Humanistic) on a continuous measure of depression scores.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy import stats
group_a = [7,4,6,8,5]; group_b = [3,5,2,4,6]; group_c = [8,9,7,10,9]
f_stat, p_value = stats.f_oneway(group_a, group_b, group_c)
print(f"P-value: {p_value}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="comparison">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Repeated Measures ANOVA</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To compare the means of a continuous variable across three or more related groups or time points.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you have one continuous dependent variable measured on the same subjects at three or more time points or under three or more different conditions.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Measuring a patient's mood score at the beginning, middle, and end of a 3-month treatment plan to see if there is a change over time.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from statsmodels.stats.anova import AnovaRM
import pandas as pd
data = {'s': [1,2,3,4,1,2,3,4,1,2,3,4],
        't': ['T1','T1','T1','T1','T2','T2','T2','T2','T3','T3','T3','T3'],
        'score': [8,7,6,8, 7,6,5,7, 5,4,3,4]}
df = pd.DataFrame(data)
aov = AnovaRM(data=df, depvar='score', subject='s', within=['t']).fit()
print(aov)</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="comparison">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Tukey’s HSD Post-Hoc Test</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To identify which specific group means are different from each other after a significant overall ANOVA result.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">After you have conducted a One-Way ANOVA and found a statistically significant result (p < .05). It performs all possible pairwise comparisons between group means.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">An ANOVA shows a significant difference in depression scores among three therapies. Tukey's HSD is then used to see if Therapy A's mean is different from B, A from C, and B from C.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from statsmodels.stats.multicomp import pairwise_tukeyhsd
import pandas as pd
df = pd.DataFrame({
    'group': ['A']*5 + ['B']*5 + ['C']*5,
    'score': [10,12,11,13,12, 20,22,21,23,22, 12,14,13,15,14]
})
tukey = pairwise_tukeyhsd(endog=df['score'], groups=df['group'], alpha=0.05)
print(tukey)</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="comparison">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Bonferroni Correction</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To adjust p-values when performing multiple statistical comparisons to reduce the chance of making a Type I error (a "false positive").</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you are conducting multiple independent statistical tests on the same dataset. It is a conservative method for controlling the family-wise error rate.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Comparing a control group to three different treatment groups using three separate t-tests. The correction adjusts the p-value threshold for significance (e.g., from 0.05 to 0.05/3).</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from statsmodels.stats.multitest import multipletests
import numpy as np

# P-values from multiple t-tests
p_values = [0.01, 0.03, 0.04, 0.20, 0.35]

# Bonferroni correction
reject, pvals_corrected, _, _ = multipletests(p_values, alpha=0.05, method='bonferroni')

print(f"Corrected p-values: {np.round(pvals_corrected, 3)}")
print(f"Significant results (reject null): {reject}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="association">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Pearson Correlation</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To measure the strength and direction of a linear relationship between two continuous variables.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you have two continuous variables and hypothesize that as one increases, the other either increases or decreases in a straight-line fashion.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Investigating whether there is a linear relationship between the number of hours a student studied and their final exam score.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy import stats
hours = [2, 3, 5, 1, 6, 4, 7, 2, 5, 8]
score = [65, 70, 85, 60, 90, 75, 95, 68, 88, 98]
r, p_value = stats.pearsonr(hours, score)
print(f"Pearson R: {r}, P-value: {p_value}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="association">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Spearman Correlation</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To measure the strength and direction of a monotonic relationship (as one variable increases, the other consistently increases or decreases, but not necessarily in a straight line) between two variables.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">As a non-parametric alternative to the Pearson correlation. It is suitable when the assumptions of Pearson are not met (e.g., non-linear relationship) or when one or both variables are ordinal.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Investigating the relationship between a runner's finishing rank in a race (ordinal data) and the number of hours they trained per week.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy.stats import spearmanr
stress = [8, 7, 5, 3, 2, 4, 6, 9, 1, 10]
perf = [3, 4, 6, 8, 9, 7, 5, 2, 10, 1]
rho, p_value = spearmanr(stress, perf)
print(f"Spearman Rho: {rho}, P-value: {p_value}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="association">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Chi-Square Test of Independence</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To determine if there is a statistically significant association between two categorical variables.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you have count data for two categorical variables and want to know if they are independent of one another.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Investigating if there is a relationship between a person's favorite season (e.g., Winter, Spring, Summer, Fall) and their preferred type of vacation (e.g., Beach, City, Mountains).</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy.stats import chi2_contingency
import pandas as pd
# Contingency table: [row1], [row2]
observed = [[25, 10], [15, 20]] # Therapy A/B vs Improved/Not
chi2, p_val, _, _ = chi2_contingency(observed)
print(f"Chi-Square: {chi2}, P-value: {p_val}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="prediction">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Simple Linear Regression</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To model and predict the value of one continuous outcome (DV) based on the value of one continuous predictor (IV).</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you have one continuous dependent variable and one continuous independent variable, and you want to create a linear equation that best predicts the DV from the IV.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Predicting a university student's final exam score based on the number of hours they studied throughout the semester.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import statsmodels.api as sm
hours = [2, 3, 5, 1, 6, 4, 7, 2, 5, 8]
score = [65, 70, 85, 60, 90, 75, 95, 68, 88, 98]
X = sm.add_constant(hours) # Add intercept
model = sm.OLS(score, X).fit()
print(model.summary())</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                 <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="prediction">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Multiple Linear Regression</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To model and predict the value of one continuous outcome (DV) based on the values of two or more predictor (IV) variables.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you want to understand the combined predictive power of several independent variables on a single continuous dependent variable.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Predicting a person's annual salary based on their years of education, years of work experience, and IQ score.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import statsmodels.api as sm
import pandas as pd
data = {'score': [65,70,85,60,90,75,95,68,88,98],
        'hours': [2,3,5,1,6,4,7,2,5,8],
        'iq': [100,105,110,95,115,102,120,98,108,125]}
df = pd.DataFrame(data)
X = df[['hours', 'iq']]
y = df['score']
X = sm.add_constant(X)
model = sm.OLS(y, X).fit()
print(model.summary())</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="prediction">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Logistic Regression</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To predict the probability of a categorical outcome (with two levels) from one or more predictor variables.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When your dependent variable is binary (e.g., pass/fail, yes/no, 0/1) and you want to see how one or more IVs influence that outcome.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Predicting the likelihood of a student passing or failing an exam (binary outcome) based on the number of hours they studied (continuous IV).</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import statsmodels.api as sm
import pandas as pd
data = {'passed': [0,0,1,0,1,1,1,0,1,1],
        'hours': [1,2,5,1,6,4,7,2,5,8]}
df = pd.DataFrame(data)
X = df['hours']
y = df['passed']
X = sm.add_constant(X)
model = sm.Logit(y, X).fit()
print(model.summary())</code></pre>
                            </div>
                        </details>
                    </div>
                </div>
                
                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="nonparametric">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Mann-Whitney U Test</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">The non-parametric alternative to the Independent t-test. It compares the distributions of two independent groups.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When the assumptions of the independent t-test are violated (especially normality) or when the dependent variable is ordinal rather than continuous.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Comparing the satisfaction ratings (on a 1-5 scale) between customers of two different store locations to see if one location's customers are more satisfied.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy.stats import mannwhitneyu
group_a = [7,4,6,8,5,6,7,5,8,25]
group_b = [3,5,2,4,6,4,3,5,2,1]
u_stat, p_value = mannwhitneyu(group_a, group_b)
print(f"P-value: {p_value}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                 <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="nonparametric">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Wilcoxon Signed-Rank Test</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">The non-parametric alternative to the Paired Samples t-test. It compares two related groups or measurements.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When the normality assumption of the paired t-test is violated (i.e., the differences between pairs are not normally distributed) or the data is ordinal.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Comparing customer satisfaction ratings (on an ordinal scale) for a product before and after a recent software update.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy.stats import wilcoxon
pre = [10, 11, 12, 9, 8, 10, 11, 13, 15, 7]
post = [12, 11, 14, 10, 9, 13, 12, 15, 17, 9]
stat, p_value = wilcoxon(pre, post)
print(f"P-value: {p_value}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="nonparametric">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Kruskal-Wallis H Test</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">The non-parametric alternative to the One-Way ANOVA. It compares the distributions of three or more independent groups.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When the assumptions for a One-Way ANOVA are violated (e.g., non-normal data or unequal variances) or the dependent variable is ordinal.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Comparing the final race rankings (ordinal data) of runners who participated in one of three different training programs.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>from scipy.stats import kruskal
g_a = [7,4,6,8,25]; g_b = [3,5,2,4,1]; g_c = [8,9,7,10,30]
stat, p_value = kruskal(g_a, g_b, g_c)
print(f"P-value: {p_value}")</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="advanced">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Factorial ANOVA</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To examine the effect of two or more categorical independent variables (and their interaction) on one continuous dependent variable.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you want to test the individual "main effects" of each independent variable, as well as the "interaction effect," which is how the effect of one IV depends on the level of another IV.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Testing how a new drug (vs. placebo) and a new diet (vs. no diet) together affect a continuous measure of weight loss. You can see the effect of the drug, the effect of the diet, and if the drug works better when combined with the diet.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import statsmodels.api as sm
from statsmodels.formula.api import ols
import pandas as pd
# See card for data setup
# model = ols('score ~ C(therapy) * C(time)', data=df).fit()
# anova_table = sm.stats.anova_lm(model, typ=2)
# print(anova_table)</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                 <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="advanced">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Cronbach’s Alpha</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To measure the internal consistency or reliability of a set of items on a psychometric scale.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">After creating a survey or questionnaire, to assess if multiple items that are supposed to measure the same underlying concept (e.g., happiness) actually do so reliably.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Checking if 10 questions on a newly developed 'happiness' survey are all consistently measuring the same concept. A high alpha (e.g., > .70) suggests they are.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code># pip install pingouin
import pingouin as pg
import pandas as pd
data = {'q1': [4,5,3,4,5], 'q2': [4,5,2,3,5], 'q3': [5,4,3,4,4]}
df = pd.DataFrame(data)
alpha = pg.cronbach_alpha(data=df)
print(alpha)</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="advanced">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Exploratory Factor Analysis (EFA)</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To identify underlying latent factors (unobserved variables) from a set of observed variables.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">In the early stages of research, especially during scale development, to explore the structure of a set of variables and see which ones "group" together.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Analyzing responses from a 20-item personality questionnaire to see if the questions naturally cluster into the well-known 'Big Five' personality traits.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code># pip install factor_analyzer
from factor_analyzer import FactorAnalyzer
import pandas as pd
# df = pd.read_csv('...').dropna() # Load data
# fa = FactorAnalyzer(n_factors=2, rotation='varimax')
# fa.fit(df)
# print(fa.loadings_)</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                 <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="advanced">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Moderation Analysis</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">To test whether the relationship between two variables (X and Y) depends on the level of a third variable (the moderator, Z).</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">When you hypothesize an "it depends" scenario, also known as an interaction effect. You expect the effect of X on Y to be different for different values of Z.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Testing if the relationship between daily stress (X) and burnout (Y) depends on the level of social support (Z) a person receives. The effect of stress might be weaker for people with high social support.</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code>import statsmodels.formula.api as smf
# model = smf.ols('Y ~ X * Z', data=df).fit() # Y=DV, X=IV, Z=Moderator
# print(model.summary()) # Check significance of interaction 'X:Z'</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <div class="test-card bg-white p-6 rounded-lg shadow-md" data-category="advanced">
                    <h2 class="text-2xl font-bold mb-4" style="color: #1877F2;">Structural Equation Modeling (SEM)</h2>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Purpose</h4>
                            <p class="text-gray-700 leading-relaxed">A highly versatile technique to test complex causal models involving multiple observed and latent variables simultaneously.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">When to Use</h4>
                            <p class="text-gray-700 leading-relaxed">To test comprehensive theoretical models that specify a network of causal relationships between variables, including latent constructs that are not directly measured.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-1" style="color: #1877F2;">Example</h4>
                            <p class="text-gray-700 leading-relaxed">Testing a complete model where 'Socioeconomic Background' (a latent variable) influences 'Educational Attainment' (latent), which in turn influences 'Job Satisfaction' (latent).</p>
                        </div>
                        <details class="pt-2">
                           <summary class="font-semibold flex items-center gap-2" style="color: #1877F2;">
                                <span>Python Implementation</span>
                                <span>▼</span>
                            </summary>
                            <div class="relative mt-2">
                                <button class="copy-code-btn absolute top-2 right-2 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6ZM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"/>
                                    </svg>
                                </button>
                                <pre><code># pip install semopy
import semopy
# model_desc = "..." # Define model structure
# model = semopy.Model(model_desc)
# model.fit(data)
# print(model.inspect())</code></pre>
                            </div>
                        </details>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global State ---
            let appState = {
                data: null,
                headers: [],
            };

            // --- DOM Elements ---
            const filterButtons = document.querySelectorAll('.filter-btn');
            const testCards = document.querySelectorAll('.test-card');
            const fileInput = document.getElementById('fileInput');
            const analysisControls = document.getElementById('analysis-controls');
            const testSelector = document.getElementById('test-selector');
            const columnSelectorContainer = document.getElementById('column-selector-container');
            const runAnalysisBtn = document.getElementById('run-analysis-btn');
            const analysisOutput = document.getElementById('analysis-output');
            const previewTable = document.getElementById('preview-table');
            const searchInput = document.getElementById('search-input');

            // --- DOM Elements for Visualization ---
            const visFileInput = document.getElementById('visFileInput');
            const visualizationControls = document.getElementById('visualization-controls');
            const chartSelector = document.getElementById('chart-selector');
            const visColumnSelectorContainer = document.getElementById('vis-column-selector-container');
            const runVisualizationBtn = document.getElementById('run-visualization-btn');
            const visualizationOutput = document.getElementById('visualization-output');
            const visPreviewTable = document.getElementById('vis-preview-table');


            // --- Helper function for showing the reference guide ---
            function showAllReferenceCards() {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                testCards.forEach(card => {
                    // Show all cards EXCEPT the automation one
                    card.style.display = (card.dataset.category === 'automation' || card.dataset.category === 'visualization') ? 'none' : 'block';
                });
            }

            // --- Modified Click Handler ---
            function handleFilterClick(event) {
                const button = event.currentTarget;
                const filter = button.dataset.filter;

                if (searchInput) searchInput.value = '';

                // Toggle off if already active
                if (button.classList.contains('active')) {
                    button.classList.remove('active');
                    // Decide what to show. If it's an analysis/vis button, show analysis. Otherwise, show reference.
                    if (filter === 'automation' || filter === 'visualization') {
                         const automationBtn = document.querySelector('[data-filter="automation"]');
                         automationBtn.classList.add('active');
                         testCards.forEach(card => {
                            card.style.display = (card.dataset.category === 'automation') ? 'block' : 'none';
                        });
                    } else {
                        showAllReferenceCards();
                    }
                    return;
                }

                // Apply new filter
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                testCards.forEach(card => {
                    card.style.display = (card.dataset.category === filter) ? 'block' : 'none';
                });
            }


            // --- Event Listeners ---
            filterButtons.forEach(button => button.addEventListener('click', handleFilterClick));
            fileInput.addEventListener('change', handleFileSelect);
            testSelector.addEventListener('change', updateColumnSelectors);
            runAnalysisBtn.addEventListener('click', runAnalysis);
            searchInput.addEventListener('input', handleSearch);

            // --- Event Listeners for Visualization ---
            if (visFileInput) {
                visFileInput.addEventListener('change', handleVisFileSelect);
            }
            if (chartSelector) {
                chartSelector.addEventListener('change', updateVisColumnSelectors);
            }
            if (runVisualizationBtn) {
                runVisualizationBtn.addEventListener('click', runVisualization);
            }

             // --- Copy Code Functionality ---
            document.querySelectorAll('.copy-code-btn').forEach(button => {
                const originalContent = button.innerHTML;
                button.addEventListener('click', () => {
                    const pre = button.nextElementSibling;
                    const code = pre.querySelector('code').textContent;

                    const textArea = document.createElement('textarea');
                    textArea.value = code;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    button.textContent = 'Copied!';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                    }, 2000);
                });
            });

            // --- Initialization: Set the default view to the StatAI Analysis tool ---
            const initialFilter = 'automation';
            const initialButton = document.querySelector(`[data-filter="${initialFilter}"]`);
            if(initialButton) {
                initialButton.classList.add('active');
            }
            testCards.forEach(card => {
                card.style.display = card.dataset.category === initialFilter ? 'block' : 'none';
            });

            // --- Functions ---

            function handleSearch(event) {
                const searchTerm = event.target.value.toLowerCase().trim();

                if (searchTerm) {
                    filterButtons.forEach(btn => btn.classList.remove('active'));

                    testCards.forEach(card => {
                        const cardCategory = card.dataset.category;
                        if (cardCategory === 'automation' || cardCategory === 'visualization' || cardCategory === 'data-python') {
                            card.style.display = 'none';
                            return;
                        }

                        const title = card.querySelector('h2')?.textContent.toLowerCase() || '';
                        const paragraphs = [...card.querySelectorAll('p')].map(p => p.textContent.toLowerCase()).join(' ');
                        const cardText = title + ' ' + paragraphs;

                        if (cardText.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                } else {
                    const initialButton = document.querySelector('[data-filter="automation"]');
                    if (initialButton) {
                        initialButton.click();
                    }
                }
            }

            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    analysisOutput.textContent = `Processing "${file.name}"...`;
                    try {
                        const fileExtension = file.name.split('.').pop().toLowerCase();
                        if (fileExtension === 'csv') {
                            parseCsv(e.target.result, file.name);
                        } else if (['xlsx', 'xls'].includes(fileExtension)) {
                            parseExcel(e.target.result, file.name);
                        } else {
                            throw new Error('Unsupported file type. Please upload a CSV or Excel file.');
                        }
                    } catch (error) {
                         handleError(`Error processing file: ${error.message}`);
                    }
                };
                reader.onerror = () => handleError('Error reading file.');

                if (['xlsx', 'xls'].includes(file.name.split('.').pop().toLowerCase())) {
                     reader.readAsArrayBuffer(file);
                } else {
                     reader.readAsText(file);
                }
            }
            
            function parseCsv(csvString, fileName){
                Papa.parse(csvString, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length) {
                            throw new Error(results.errors[0].message);
                        }
                        processParsedData(results.data, results.meta.fields, fileName);
                    }
                });
            }

            function parseExcel(data, fileName){
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
                const headers = jsonData.length > 0 ? Object.keys(jsonData[0]) : [];
                processParsedData(jsonData, headers, fileName);
            }

            function processParsedData(data, headers, fileName) {
                appState.data = data;
                appState.headers = headers;
                analysisOutput.textContent = `File "${fileName}" loaded. Found ${data.length} rows and ${headers.length} columns. Please select a test.`;
                analysisControls.classList.remove('hidden');
                testSelector.value = "";
                columnSelectorContainer.innerHTML = '';
                runAnalysisBtn.disabled = true;
                displayPreview(data, headers);
                generateAnalysisRecommendations();
            }
            
            function handleError(message) {
                 analysisOutput.textContent = message;
                 analysisControls.classList.add('hidden');
                 document.getElementById('analysis-recommendation-container').classList.add('hidden');
                 appState.data = null;
                 appState.headers = [];
            }

            function displayPreview(data, headers) {
                const previewData = data.slice(0, 5);
                let tableHTML = '<thead><tr class="bg-stone-700">';
                headers.forEach(h => tableHTML += `<th class="p-2 font-semibold">${h}</th>`);
                tableHTML += '</tr></thead><tbody>';
                previewData.forEach(row => {
                    tableHTML += '<tr class="border-b border-stone-700">';
                    headers.forEach(h => tableHTML += `<td class="p-2">${row[h] === null ? 'NA' : row[h]}</td>`);
                    tableHTML += '</tr>';
                });
                previewTable.innerHTML = tableHTML + '</tbody>';
            }
            
            // CORRECTED/ADDED FUNCTION: Moved to outer scope and completed
            function createSelectHTML(id, label, options, isMultiple = false, isOptional = false) {
                let optionsHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                const multipleAttr = isMultiple ? 'multiple size="5"' : '';
                const optionalAttr = isOptional ? 'data-optional="true"' : '';
                let placeholder = '<option value="" selected disabled>Select column...</option>';
                if (isOptional) {
                    placeholder = '<option value="" selected>None</option>';
                }
                return `<div><label for="${id}" class="block mb-2 text-sm font-medium text-gray-700">${label}</label><select id="${id}" ${multipleAttr} ${optionalAttr} class="${isMultiple ? '' : 'custom-select'} bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">${isMultiple ? optionsHTML : placeholder + optionsHTML}</select></div>`;
            }

            // CORRECTED/ADDED FUNCTION: Completed the function
            function updateColumnSelectors() {
                const test = testSelector.value;
                columnSelectorContainer.innerHTML = '';
                runAnalysisBtn.disabled = true;
                if (!test || !appState.headers.length) return;
                
                let selectorsHTML = '';
                const baseHelpText = `<p class="text-sm text-stone-400 mb-2">`;
                const twoNumVars = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${createSelectHTML('var1', 'Variable 1 (Numeric)', appState.headers)}${createSelectHTML('var2', 'Variable 2 (Numeric)', appState.headers)}</div>`;
                const oneCatOneNum = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${createSelectHTML('group-var', 'Grouping Variable (Categorical)', appState.headers)}${createSelectHTML('dep-var', 'Dependent Variable (Numeric)', appState.headers)}</div>`;

                switch(test) {
                    case 'descriptive':
                    case 'shapiro':
                         selectorsHTML = `${baseHelpText}Requires one numerical variable.</p>${createSelectHTML('var1', 'Variable', appState.headers)}`;
                        break;
                    case 'levene':
                    case 'anova_one_way':
                    case 'mann_whitney': 
                    case 'kruskal_wallis':
                         selectorsHTML = `${baseHelpText}Requires one categorical grouping variable and one numerical dependent variable.</p>${oneCatOneNum}`;
                        break;
                    case 'ttest_ind':
                         selectorsHTML = `${baseHelpText}Requires one categorical variable with exactly two groups and one numerical variable.</p>${oneCatOneNum}`;
                        break;
                    case 'ttest_rel':
                    case 'wilcoxon':
                         selectorsHTML = `${baseHelpText}Requires two numerical variables representing paired measurements.</p>${twoNumVars}`;
                        break;
                    case 'pearson':
                    case 'spearman':
                        selectorsHTML = `${baseHelpText}Requires two numerical variables.</p>${twoNumVars}`;
                        break;
                    case 'chi_square':
                        selectorsHTML = `${baseHelpText}Requires two categorical variables.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${createSelectHTML('cat-var1', 'Categorical Variable 1', appState.headers)}${createSelectHTML('cat-var2', 'Categorical Variable 2', appState.headers)}</div>`;
                        break;
                    case 'simple_regression':
                        selectorsHTML = `${baseHelpText}Requires two numerical variables.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${createSelectHTML('iv-var', 'Independent Variable (X)', appState.headers)}${createSelectHTML('dv-var', 'Dependent Variable (Y)', appState.headers)}</div>`;
                        break;
                    case 'multiple_regression':
                        selectorsHTML = `${baseHelpText}Select one numerical Dependent Variable (Y) and two or more numerical Independent Variables (X). (Hold Ctrl or Cmd to select multiple IVs)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${createSelectHTML('iv-vars', 'Independent Variables (X)', appState.headers, true)}
                            ${createSelectHTML('dv-var', 'Dependent Variable (Y)', appState.headers)}
                        </div>`;
                        break;
                    case 'logistic_regression':
                        selectorsHTML = `${baseHelpText}Select one binary (0/1) Dependent Variable and one or more numerical Independent Variables. (Hold Ctrl or Cmd to select multiple IVs)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${createSelectHTML('iv-vars', 'Independent Variables (X)', appState.headers, true)}
                            ${createSelectHTML('dv-var', 'Dependent Variable (Y)', appState.headers)}
                        </div>`;
                        break;
                    case 'factorial_anova':
                        selectorsHTML = `${baseHelpText}Select two categorical Independent Variables and one numerical Dependent Variable.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${createSelectHTML('iv1-var', 'Independent Variable 1 (Categorical)', appState.headers)}
                            ${createSelectHTML('iv2-var', 'Independent Variable 2 (Categorical)', appState.headers)}
                        </div>
                        ${createSelectHTML('dv-var', 'Dependent Variable (Y, Numeric)', appState.headers)}`;
                        break;
                    case 'moderation':
                         selectorsHTML = `${baseHelpText}Select one numerical DV, one numerical IV, and one numerical Moderator.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${createSelectHTML('iv-var', 'Independent Variable (X)', appState.headers)}
                            ${createSelectHTML('mod-var', 'Moderator (Z)', appState.headers)}
                        </div>
                        ${createSelectHTML('dv-var', 'Dependent Variable (Y)', appState.headers)}`;
                        break;
                    case 'cronbach_alpha':
                        selectorsHTML = `${baseHelpText}Select two or more numerical item columns that form a scale. (Hold Ctrl or Cmd to select multiple)</p>${createSelectHTML('items', 'Scale Items', appState.headers, true)}`;
                        break;
                }
                columnSelectorContainer.innerHTML = selectorsHTML;
                columnSelectorContainer.querySelectorAll('select').forEach(sel => sel.addEventListener('change', checkRunButtonState));
            }

            function checkRunButtonState() {
                 const selects = [...columnSelectorContainer.querySelectorAll('select')];
                 const test = testSelector.value;
                 const allSelected = selects.every(sel => {
                    if (sel.multiple) {
                        if (test === 'cronbach_alpha' || test === 'multiple_regression') {
                            return sel.selectedOptions.length >= 2;
                        }
                        if (test === 'logistic_regression') {
                            return sel.selectedOptions.length >= 1;
                        }
                    }
                    return sel.value;
                });
                runAnalysisBtn.disabled = !allSelected;
            }

            function getColumn(columnName) {
                 return appState.data.map(row => row[columnName]).filter(val => val !== null && val !== undefined);
            }
            
            function getNumericColumn(columnName) {
                return getColumn(columnName).filter(val => !isNaN(parseFloat(val))).map(parseFloat);
            }

            // --- Analysis Runner ---
            function runAnalysis() {
                const test = testSelector.value;
                analysisOutput.innerHTML = 'Calculating...';
                analysisOutput.classList.add('loading');
                
                setTimeout(() => {
                    let resultObj = null;
                    try {
                         if (typeof jStat === 'undefined' || typeof ss === 'undefined') {
                            throw new Error('Statistical libraries could not be loaded. Please check your internet connection and refresh the page.');
                        }
                        switch(test) {
                            case 'descriptive': resultObj = runDescriptive(); break;
                            case 'shapiro': resultObj = runShapiro(); break;
                            case 'levene': resultObj = runLevene(); break;
                            case 'cronbach_alpha': resultObj = runCronbachAlpha(); break;
                            case 'ttest_ind': resultObj = runTTestInd(); break;
                            case 'ttest_rel': resultObj = runTTestRel(); break;
                            case 'anova_one_way': resultObj = runAnova(); break;
                            case 'factorial_anova': resultObj = runFactorialAnova(); break;
                            case 'mann_whitney': resultObj = runMannWhitney(); break;
                            case 'wilcoxon': resultObj = runWilcoxon(); break;
                            case 'kruskal_wallis': resultObj = runKruskalWallis(); break;
                            case 'pearson': resultObj = runPearson(); break;
                            case 'spearman': resultObj = runSpearman(); break;
                            case 'chi_square': resultObj = runChiSquare(); break;
                            case 'simple_regression': resultObj = runSimpleRegression(); break;
                            case 'multiple_regression': resultObj = runMultipleRegression(); break;
                            case 'logistic_regression': resultObj = runLogisticRegression(); break;
                            case 'moderation': resultObj = runModeration(); break;
                            default: throw new Error("Please select a valid test.");
                        }
                        
                        const outputHTML = `
                            <h5 class="text-lg font-bold mb-2" style="color: #1877F2;">${resultObj.title}</h5>
                            <pre class="font-mono bg-gray-100 p-3 rounded border border-gray-200 whitespace-pre-wrap text-sm">${resultObj.results}</pre>
                            <h6 class="font-semibold text-gray-800 mt-4 mb-1">Interpretation:</h6>
                            <p class="text-gray-700 text-sm">${resultObj.interpretation}</p>
                            <h6 class="font-semibold text-gray-800 mt-4 mb-1">Recommended Next Steps:</h6>
                            <p class="text-gray-700 text-sm">${resultObj.recommendations}</p>
                        `;
                        analysisOutput.innerHTML = outputHTML;

                    } catch (e) {
                        analysisOutput.innerHTML = `<p class="text-red-400 font-semibold">Error: ${e.message}</p>`;
                    }
                    analysisOutput.classList.remove('loading');
                }, 10);
            }
            
            // --- Helper Functions ---
            function getAlphaInterpretation(alpha) {
                if (alpha > 0.9) return 'an excellent level of internal consistency';
                if (alpha > 0.8) return 'a good level of internal consistency';
                if (alpha > 0.7) return 'an acceptable level of internal consistency';
                if (alpha > 0.6) return 'a questionable level of internal consistency';
                return 'an unacceptable level of internal consistency';
            }

            function getCorrelationStrength(r) {
                const absR = Math.abs(r);
                let strength = '';
                if (absR >= 0.8) strength = 'very strong';
                else if (absR >= 0.6) strength = 'strong';
                else if (absR >= 0.4) strength = 'moderate';
                else if (absR >= 0.2) strength = 'weak';
                else strength = 'very weak or no';

                let direction = r > 0 ? 'positive' : 'negative';
                if (absR < 0.1) direction = '';
                
                return `${strength} ${direction}`;
            }

            function rankData(arr) {
                const sorted = [...arr].sort((a, b) => a - b);
                const ranks = arr.map(v => {
                    const firstIndex = sorted.indexOf(v);
                    const lastIndex = sorted.lastIndexOf(v);
                    if (firstIndex === lastIndex) return firstIndex + 1;
                    const avgRank = (firstIndex + 1 + lastIndex + 1) / 2;
                    return avgRank;
                });
                return ranks;
            }
            
            function calculateAnovaF(groups) {
                const k = groups.length;
                if (k < 2) return null;
                const allData = [].concat(...groups);
                const N = allData.length;
                if (N === 0) return null;
                const grandMean = ss.mean(allData);
                let SSB = 0;
                const groupMeans = groups.map(g => ss.mean(g));
                groups.forEach((group, i) => {
                    SSB += group.length * Math.pow(groupMeans[i] - grandMean, 2);
                });
                let SSW = 0;
                groups.forEach((group, i) => {
                    let groupSumSquares = group.reduce((acc, val) => acc + Math.pow(val - groupMeans[i], 2), 0);
                    SSW += groupSumSquares;
                });
                const df_between = k - 1;
                const df_within = N - k;
                if (df_within <= 0) return null;
                const MSB = SSB / df_between;
                const MSW = SSW / df_within;
                if (MSW === 0) return { f: Infinity, df_b: df_between, df_w: df_within };
                const f = MSB / MSW;
                return { f: f, df_b: df_between, df_w: df_within };
            }


            // --- Individual Test Functions ---

            function runDescriptive() {
                const varName = document.getElementById('var1').value;
                const var1 = getNumericColumn(varName);
                if (var1.length < 1) throw new Error('Selected column contains no valid numeric data.');
                const results = `Variable: "${varName}"\n\n` +
                       `Count: ${var1.length}\n` +
                       `Mean: ${ss.mean(var1).toFixed(3)}\n` +
                       `Median: ${ss.median(var1).toFixed(3)}\n` +
                       `Min: ${ss.min(var1).toFixed(3)}\n` +
                       `Max: ${ss.max(var1).toFixed(3)}\n` +
                       `Standard Deviation: ${ss.standardDeviation(var1).toFixed(3)}\n` +
                       `Variance: ${ss.variance(var1).toFixed(3)}`;
                const interpretation = `Descriptive analysis of the variable "${varName}" revealed a mean of ${ss.mean(var1).toFixed(3)} (SD = ${ss.standardDeviation(var1).toFixed(3)}). This indicates that the central or average value for this variable is ${ss.mean(var1).toFixed(3)}, with data points typically deviating from this average by about ${ss.standardDeviation(var1).toFixed(3)}. This initial summary provides a foundational understanding of the variable's distribution.`;
                const recommendations = `1. Check for normality using the 'Normality Test' to see if your data follows a bell curve, a key assumption for many tests.\n2. Visualize the variable's distribution with a histogram or boxplot to identify its shape and any potential outliers.`;
                return { title: "Descriptive Statistics", results, interpretation, recommendations };
            }

             function runShapiro() {
                const varName = document.getElementById('var1').value;
                const data = getNumericColumn(varName);
                if (data.length < 3) throw new Error('Normality testing requires at least 3 data points.');
                const skew = ss.sampleSkewness(data);
                const kurt = ss.sampleKurtosis(data);
                let normalityAdvice = "A normal distribution has a skewness and kurtosis near 0.";
                if (Math.abs(skew) > 1 || Math.abs(kurt) > 1) {
                    normalityAdvice += " These values suggest a deviation from normality."
                } else {
                     normalityAdvice += " These values are close to what you would expect for a normal distribution."
                }
                const results = `Variable: "${varName}"\n\n` +
                       `Sample Skewness: ${skew.toFixed(4)}\n` +
                       `Sample Kurtosis: ${kurt.toFixed(4)}\n\n` +
                       `(Note: For a formal p-value, use the Shapiro-Wilk code in a Python environment.)`;
                const interpretation = `An assessment of the data's distribution for "${varName}" was conducted by examining skewness and kurtosis. The skewness was found to be ${skew.toFixed(4)}, and the kurtosis was ${kurt.toFixed(4)}. In a perfectly normal distribution, both values are close to zero. ${normalityAdvice} This is a critical step for determining whether the assumptions for certain parametric statistical tests are met.`;
                const recommendations = `If data appears normal, proceed with parametric tests (like t-tests or ANOVA). If it's non-normal, consider using non-parametric alternatives (like Mann-Whitney U or Kruskal-Wallis).`;
                return { title: "Normality Assessment", results, interpretation, recommendations };
            }

            function runLevene() {
                const groupVar = document.getElementById('group-var').value;
                const depVar = document.getElementById('dep-var').value;
                const groupLabels = [...new Set(getColumn(groupVar))];
                if (groupLabels.length < 2) throw new Error("Levene's Test requires at least 2 groups.");
                const transformedGroups = groupLabels.map(label => {
                    const groupData = appState.data.filter(r => r[groupVar] === label).map(r => r[depVar]).filter(v => v != null && !isNaN(v)).map(parseFloat);
                    if (groupData.length === 0) return [];
                    const median = ss.median(groupData);
                    return groupData.map(v => Math.abs(v - median));
                }).filter(g => g.length > 0);
                if(transformedGroups.some(g => g.length < 2)) throw new Error("Each group must have at least 2 data points.");
                const anovaResult = calculateAnovaF(transformedGroups);
                if (!anovaResult) throw new Error("Could not calculate Levene's test. Check group data.");
                const { f, df_b, df_w } = anovaResult;
                const p_value = 1 - jStat.centralF.cdf(f, df_b, df_w);
                const isSig = p_value < 0.05;
                const results = `F(${df_b}, ${df_w}) = ${f.toFixed(4)}\n` +
                       `p-value = ${p_value.toFixed(4)}`;
                const interpretation = `Levene's test for homogeneity of variances was conducted to assess the assumption that the groups have equal variance on the dependent variable. The result of the test was ${isSig ? 'statistically significant' : 'not statistically significant'}, F(${df_b}, ${df_w}) = ${f.toFixed(4)}, p = ${p_value.toFixed(4)}. ${isSig ? 'A significant result (p < .05) indicates that the variances are unequal across groups, violating the assumption.' : 'A non-significant result (p > .05) is desired, and in this case, it indicates that the variances are sufficiently equal across the groups, and the assumption is met.'} This finding informs the selection of subsequent statistical tests.`;
                const recommendations = isSig ? `Since the result is significant (variances are unequal), you should be cautious using a standard ANOVA or t-test. Consider using a non-parametric alternative like the Kruskal-Wallis test.` : `Since the result is not significant, you have met the assumption of homogeneity of variances and can proceed with an Independent t-test or ANOVA.`;
                return { title: "Levene's Test for Homogeneity of Variances", results, interpretation, recommendations };
            }
            
            function runCronbachAlpha() {
                const itemsSelect = document.getElementById('items');
                const selectedItems = [...itemsSelect.selectedOptions].map(opt => opt.value);
                if (selectedItems.length < 2) throw new Error("Cronbach's Alpha requires at least two items.");
                const cleanData = appState.data.map(row => {
                    const itemData = {};
                    let hasMissing = false;
                    for (const item of selectedItems) {
                        const val = parseFloat(row[item]);
                        if (isNaN(val)) {
                            hasMissing = true;
                            break;
                        }
                        itemData[item] = val;
                    }
                    return hasMissing ? null : itemData;
                }).filter(row => row !== null);
                if (cleanData.length < 2) throw new Error("Not enough complete cases (rows with numbers in all selected columns) to calculate reliability.");
                const k = selectedItems.length;
                const itemVariances = selectedItems.map(item => ss.variance(cleanData.map(row => row[item])));
                const sumOfItemVariances = itemVariances.reduce((a, b) => a + b, 0);
                const totalScores = cleanData.map(row => selectedItems.reduce((sum, item) => sum + row[item], 0));
                const varianceOfTotalScores = ss.variance(totalScores);
                if (varianceOfTotalScores === 0) throw new Error("Total score variance is zero. Cannot calculate alpha (this may happen if all respondents have the same total score).");
                const alpha = (k / (k - 1)) * (1 - (sumOfItemVariances / varianceOfTotalScores));
                const results = `Number of items: ${k}\n` +
                       `Number of cases: ${cleanData.length}\n` +
                       `Cronbach's Alpha = ${alpha.toFixed(4)}`;
                const interpretation = `A reliability analysis was performed on the selected scale items. The internal consistency of the scale, as measured by Cronbach's Alpha, was found to be α = ${alpha.toFixed(4)}. This value indicates ${getAlphaInterpretation(alpha)}. In simple terms, this means the items on your scale are ${alpha > 0.7 ? 'consistently and reliably' : 'not consistently'} measuring the same underlying concept. This is important for ensuring the quality of your measurement tool.`;
                const recommendations = `If your alpha is acceptable or good, you can be more confident in using the sum or average of these items as a single scale score in further analyses (e.g., correlations, regressions). If it's low, you may need to revise or remove items from your scale.`;
                 return { title: "Cronbach's Alpha (Internal Consistency)", results, interpretation, recommendations };
            }

            function runTTestInd() {
                const groupVar = document.getElementById('group-var').value;
                const depVar = document.getElementById('dep-var').value;
                const groups = [...new Set(getColumn(groupVar))];
                if (groups.length !== 2) throw new Error(`Grouping variable must have exactly 2 unique groups. Found: ${groups.length} (${groups.join(', ')})`);
                const groupA = appState.data.filter(r => r[groupVar] === groups[0]).map(r => r[depVar]).filter(v => v != null && !isNaN(v)).map(parseFloat);
                const groupB = appState.data.filter(r => r[groupVar] === groups[1]).map(r => r[depVar]).filter(v => v != null && !isNaN(v)).map(parseFloat);
                if (groupA.length < 2 || groupB.length < 2) throw new Error('Each group must have at least 2 valid data points.');
                const t_stat = ss.tTestTwoSample(groupA, groupB);
                const df = groupA.length + groupB.length - 2;
                const p_value = jStat.studentt.cdf(-Math.abs(t_stat), df) * 2;
                const isSig = p_value < 0.05;
                const meanA = ss.mean(groupA);
                const meanB = ss.mean(groupB);
                const results = `Group "${groups[0]}": n=${groupA.length}, M=${meanA.toFixed(3)}, SD=${ss.standardDeviation(groupA).toFixed(3)}\n` +
                       `Group "${groups[1]}": n=${groupB.length}, M=${meanB.toFixed(3)}, SD=${ss.standardDeviation(groupB).toFixed(3)}\n\n` +
                       `t(${df}) = ${t_stat.toFixed(4)}\n` +
                       `p-value = ${p_value.toFixed(4)}`;
                const interpretation = `An independent-samples t-test was conducted to compare the means of the dependent variable between the "${groups[0]}" and "${groups[1]}" groups. The analysis yielded a ${isSig ? 'statistically significant' : 'non-statistically significant'} result, t(${df}) = ${t_stat.toFixed(4)}, p = ${p_value.toFixed(4)}. ${isSig ? `This indicates that there is a reliable difference between the two groups. Specifically, the mean for the "${groups[0]}" group (M = ${meanA.toFixed(3)}) was significantly ${meanA > meanB ? 'higher' : 'lower'} than the mean for the "${groups[1]}" group (M = ${meanB.toFixed(3)}).` : 'This result suggests that there is no reliable evidence of a difference in means between the two groups.'}`;
                const recommendations = `Before concluding, ensure your data meets the test's assumptions: normality (check with 'Normality Test') and homogeneity of variances (check with 'Levene's Test'). If assumptions are violated, consider the 'Mann-Whitney U Test'.`;
                return { title: "Independent Samples t-test", results, interpretation, recommendations };
            }
            
            function runTTestRel(){
                 const var1name = document.getElementById('var1').value;
                 const var2name = document.getElementById('var2').value;
                 const var1 = getNumericColumn(var1name);
                 const var2 = getNumericColumn(var2name);
                 if (var1.length !== var2.length || var1.length < 2) throw new Error('Paired variables must have the same number of valid numeric data points (min 2).');
                 const t = ss.tTest(var1, var2);
                 const df = var1.length - 1;
                 const p = jStat.studentt.cdf(-Math.abs(t), df) * 2;
                 const isSig = p < 0.05;
                 const results = `t(${df}) = ${t.toFixed(4)}\n` +
                        `p-value = ${p.toFixed(4)}`;
                 const interpretation = `A paired-samples t-test was performed to evaluate the difference between the means of two related measurements ("${var1name}" and "${var2name}"). The result was found to be ${isSig ? 'statistically significant' : 'not statistically significant'}, t(${df}) = ${t.toFixed(4)}, p = ${p.toFixed(4)}. ${isSig ? 'This suggests that there is a reliable difference between the two conditions or time points. In other words, the change observed between the first and second measurement is unlikely to be due to random chance.' : 'This suggests that there is no reliable evidence of a difference between the two measurements; any observed difference is likely due to random chance.'}`;
                 const recommendations = `Ensure the *differences* between your paired scores are approximately normally distributed. If not, consider using the non-parametric 'Wilcoxon Signed-Rank Test' as an alternative.`;
                 return { title: "Paired Samples t-test", results, interpretation, recommendations };
            }
            
            function runAnova(){
                const groupVar = document.getElementById('group-var').value;
                const depVar = document.getElementById('dep-var').value;
                const groupLabels = [...new Set(getColumn(groupVar))];
                if (groupLabels.length < 2) throw new Error('ANOVA requires a grouping variable with at least 2 unique groups.');
                const groups = groupLabels.map(label => appState.data.filter(r => r[groupVar] === label).map(r => r[depVar]).filter(v => v != null && !isNaN(v)).map(parseFloat));
                if (groups.some(g => g.length < 2)) throw new Error('Each group must have at least 2 valid numeric data points.');
                const anovaResult = calculateAnovaF(groups);
                if (!anovaResult) throw new Error("Could not calculate ANOVA. Check if each group has data.");
                const { f, df_b, df_w } = anovaResult;
                const p_value = 1 - jStat.centralF.cdf(f, df_b, df_w);
                const isSig = p_value < 0.05;
                let summary = `--- Group Summaries ---\n`;
                groups.forEach((g, i) => {
                    summary += `Group "${groupLabels[i]}": n=${g.length}, M=${ss.mean(g).toFixed(3)}, SD=${ss.standardDeviation(g).toFixed(3)}\n`;
                });
                summary += `--- ANOVA Result ---\n`;
                summary += `F(${df_b}, ${df_w}) = ${f.toFixed(4)}\n`;
                summary += `p-value = ${p_value.toFixed(4)}`;
                const interpretation = `A one-way analysis of variance (ANOVA) was conducted to examine the effect of the grouping variable on the dependent variable. The analysis revealed a ${isSig ? 'statistically significant' : 'non-statistically significant'} effect, F(${df_b}, ${df_w}) = ${f.toFixed(4)}, p = ${p_value.toFixed(4)}. ${isSig ? 'This significant result indicates that there is a reliable difference in the means of the dependent variable across at least two of the groups. It means the group a participant belongs to has a significant effect on their score.' : 'This non-significant result suggests that there is no reliable evidence of a difference in means among the groups. The group a participant belongs to does not appear to have an effect on their score.'}`;
                const recommendations = isSig ? `Since the overall test is significant, you should run a post-hoc test (like Tukey's HSD, available in Python) to determine exactly which pairs of groups are different from each other.` : `No further tests are needed, as there is no evidence of a difference between the groups. Be sure to check the assumptions of normality and homogeneity of variances.`;
                return { title: "One-Way ANOVA", results: summary, interpretation, recommendations };
            }

            function runMannWhitney() {
                const groupVar = document.getElementById('group-var').value;
                const depVar = document.getElementById('dep-var').value;
                const groupLabels = [...new Set(getColumn(groupVar))];
                if (groupLabels.length !== 2) throw new Error(`Mann-Whitney U Test requires exactly 2 groups. Found: ${groupLabels.length}`);
                const groupA = appState.data.filter(r => r[groupVar] === groupLabels[0]).map(r => r[depVar]).filter(v => v != null && !isNaN(parseFloat(v))).map(parseFloat);
                const groupB = appState.data.filter(r => r[groupVar] === groupLabels[1]).map(r => r[depVar]).filter(v => v != null && !isNaN(parseFloat(v))).map(parseFloat);
                if (groupA.length < 1 || groupB.length < 1) throw new Error("Each group must have at least one data point.");
                const combined = groupA.concat(groupB);
                const ranks = rankData(combined);
                const R1 = ranks.slice(0, groupA.length).reduce((a, b) => a + b, 0);
                const n1 = groupA.length;
                const n2 = groupB.length;
                const U1 = R1 - (n1 * (n1 + 1)) / 2;
                const U2 = n1 * n2 - U1;
                const U = Math.min(U1, U2);
                const mu = n1 * n2 / 2;
                const sigma = Math.sqrt(n1 * n2 * (n1 + n2 + 1) / 12);
                const z = (U - mu) / sigma;
                const p = 2 * (1 - jStat.normal.cdf(Math.abs(z), 0, 1));
                const isSig = p < 0.05;
                const results = `U Statistic = ${U.toFixed(2)}\n` +
                       `Z-score = ${z.toFixed(4)}\n` +
                       `p-value (approx.) = ${p.toFixed(4)}`;
                const interpretation = `A Mann-Whitney U test was conducted to compare the distributions of the dependent variable between the two independent groups. The result of the test was ${isSig ? 'statistically significant' : 'not statistically significant'}, U = ${U.toFixed(2)}, p = ${p.toFixed(4)}. ${isSig ? 'This indicates that there is a reliable difference in the distributions of scores between the two groups. In simpler terms, one group tends to have significantly higher or lower ranked scores than the other.' : 'This suggests that there is no reliable evidence of a difference in the distributions of scores between the two groups.'}`;
                const recommendations = `Report the median for each group to describe the central tendency, as the test is based on ranks, not means. This test is a good choice when your data is not normally distributed.`;
                return { title: "Mann-Whitney U Test", results, interpretation, recommendations };
            }

            function runFactorialAnova() {
                const dvName = document.getElementById('dv-var').value;
                const iv1Name = document.getElementById('iv1-var').value;
                const iv2Name = document.getElementById('iv2-var').value;
                
                if (iv1Name === iv2Name) throw new Error("Independent variables must be different.");

                const cleanData = appState.data.map(row => ({
                    dv: parseFloat(row[dvName]),
                    iv1: row[iv1Name],
                    iv2: row[iv2Name]
                })).filter(r => !isNaN(r.dv) && r.iv1 != null && r.iv2 != null);

                const iv1Levels = [...new Set(cleanData.map(r => r.iv1))];
                const iv2Levels = [...new Set(cleanData.map(r => r.iv2))];

                if (iv1Levels.length < 2 || iv2Levels.length < 2) {
                    throw new Error("Each independent variable must have at least 2 levels (groups).");
                }
                
                const groups = [];
                for (const l1 of iv1Levels) {
                    for (const l2 of iv2Levels) {
                        const groupData = cleanData.filter(r => r.iv1 === l1 && r.iv2 === l2).map(r => r.dv);
                        // Only add the group if it has data to avoid empty groups in the ANOVA calculation
                        if (groupData.length > 0) {
                           groups.push(groupData);
                        }
                    }
                }
                
                if (groups.length < 2) {
                    throw new Error("Could not form at least two valid groups for the analysis. Check your data for empty cells in combinations of your IVs.");
                }

                const anovaResult = calculateAnovaF(groups);
                if (!anovaResult) throw new Error("Could not calculate ANOVA component. Ensure each group combination has sufficient data.");

                const { f, df_b, df_w } = anovaResult;
                const p = 1 - jStat.centralF.cdf(f, df_b, df_w);
                
                const design = `${iv1Levels.length}x${iv2Levels.length}`;

                const results = `Overall F(${df_b}, ${df_w}) = ${f.toFixed(4)}\n` +
                       `p-value = ${p.toFixed(4)}`;
                const interpretation = `A factorial analysis of variance (ANOVA) was conducted to examine the effects of two independent variables on the dependent variable. The overall model, tested as a one-way ANOVA across all conditions of the ${design} design, was found to be ${p < 0.05 ? 'statistically significant' : 'not statistically significant'}, F(${df_b}, ${df_w}) = ${f.toFixed(4)}, p = ${p.toFixed(4)}. ${p < 0.05 ? 'This indicates that there is at least one significant difference among the various group combinations.' : 'This indicates that there are no significant differences among the means of the various group combinations.'} It is important to note that this is an omnibus test; it does not specify whether the differences are due to the first independent variable, the second, or their combined interaction effect.`;
                const recommendations = `For a complete analysis, use the Python code guide. A full Factorial ANOVA will provide separate F-tests for the Main Effect of IV1, the Main Effect of IV2, and, crucially, the Interaction Effect between them. The interaction is often the most interesting finding.`;
                return { title: `Factorial ANOVA (${design})`, results, interpretation, recommendations };
            }

            function runWilcoxon() {
                const var1 = getNumericColumn(document.getElementById('var1').value);
                const var2 = getNumericColumn(document.getElementById('var2').value);
                if (var1.length !== var2.length || var1.length < 2) throw new Error('Paired variables must have the same number of valid numeric data points (min 2).');
                const diffs = var1.map((d, i) => d - var2[i]).filter(d => d !== 0);
                if (diffs.length === 0) return { title: "Wilcoxon Signed-Rank Test", results: `All differences are zero. Test cannot be performed.`, interpretation: '', recommendations: ''};
                const ranks = rankData(diffs.map(Math.abs));
                let W_plus = 0, W_minus = 0;
                diffs.forEach((d, i) => {
                    if (d > 0) W_plus += ranks[i];
                    else W_minus += ranks[i];
                });
                const W = Math.min(W_plus, W_minus);
                const n = diffs.length;
                const mu = n * (n + 1) / 4;
                const sigma = Math.sqrt(n * (n + 1) * (2 * n + 1) / 24);
                const z = (W - mu) / sigma;
                const p = 2 * jStat.normal.cdf(z, 0, 1);
                const isSig = p < 0.05;
                const results = `W Statistic = ${W.toFixed(2)}\n` +
                        `Z-score = ${z.toFixed(4)}\n` +
                        `p-value (approx.) = ${p.toFixed(4)}`;
                const interpretation = `A Wilcoxon Signed-Rank test was performed to evaluate the difference between two related measurements. The test yielded a ${isSig ? 'statistically significant' : 'not statistically significant'} result, W = ${W.toFixed(2)}, p = ${p.toFixed(4)}. ${isSig ? 'This indicates a reliable difference between the two measurements, suggesting that the change from the first to the second measurement is systematic and not due to chance.' : 'This result suggests there is no reliable evidence of a difference between the two related measurements. Any observed changes are likely due to random variation.'}`;
                const recommendations = `Report the median values for both conditions to describe the data. This test is appropriate when the differences between your paired measurements are not normally distributed.`;
                return { title: "Wilcoxon Signed-Rank Test", results, interpretation, recommendations };
            }
            
            function runKruskalWallis() {
                const groupVar = document.getElementById('group-var').value;
                const depVar = document.getElementById('dep-var').value;
                const groupLabels = [...new Set(getColumn(groupVar))];
                if (groupLabels.length < 2) throw new Error("Kruskal-Wallis requires at least 2 groups.");
                const groups = groupLabels.map(label =>
                    appState.data
                        .filter(r => r[groupVar] === label)
                        .map(r => r[depVar])
                        .filter(v => v != null && !isNaN(parseFloat(v)))
                        .map(parseFloat)
                );
                if (groups.some(g => g.length < 1)) throw new Error("All groups must have at least one data point.");
                const N = groups.reduce((acc, g) => acc + g.length, 0);
                const allData = [].concat(...groups);
                const allRanks = rankData(allData);
                let rankSumSquares = 0;
                let currentRank = 0;
                groups.forEach(group => {
                    const groupRankSum = allRanks.slice(currentRank, currentRank + group.length).reduce((a, b) => a + b, 0);
                    rankSumSquares += Math.pow(groupRankSum, 2) / group.length;
                    currentRank += group.length;
                });
                const H = (12 / (N * (N + 1))) * rankSumSquares - 3 * (N + 1);
                const df = groups.length - 1;
                const p = 1 - jStat.chisquare.cdf(H, df);
                const isSig = p < 0.05;
                const results = `H Statistic = ${H.toFixed(4)}\n` +
                       `Degrees of freedom = ${df}\n` +
                       `p-value = ${p.toFixed(4)}`;
                const interpretation = `A Kruskal-Wallis H test was conducted to examine differences in the dependent variable across three or more independent groups. The analysis revealed a ${isSig ? 'statistically significant' : 'non-statistically significant'} result, H(${df}) = ${H.toFixed(4)}, p = ${p.toFixed(4)}. ${isSig ? 'This significant result indicates that the distribution of scores is not the same across all groups. In other words, at least one group has a distribution of scores that is reliably different from at least one other group.' : 'This non-significant result suggests that there is no reliable evidence of a difference in the distribution of scores among the groups.'}`;
                const recommendations = isSig ? `Because the overall test is significant, you should perform a non-parametric post-hoc test (like Dunn's test, available in Python) to identify which specific pairs of groups are different.` : `No further tests are needed, as there's no evidence of a difference between groups. This test is a good choice when your data violates ANOVA's assumptions.`;
                return { title: "Kruskal-Wallis H Test", results, interpretation, recommendations };
            }

            function runPearson() {
                const var1 = getNumericColumn(document.getElementById('var1').value);
                const var2 = getNumericColumn(document.getElementById('var2').value);
                if (var1.length !== var2.length || var1.length < 3) throw new Error('Variables must have same number of valid data points (min 3).');
                const r = ss.sampleCorrelation(var1, var2);
                const n = var1.length;
                const t = r * Math.sqrt((n - 2) / (1 - r*r));
                const p = jStat.studentt.cdf(-Math.abs(t), n - 2) * 2;
                const isSig = p < 0.05;
                const results = `r(${n-2}) = ${r.toFixed(4)}\n` +
                        `p-value = ${p.toFixed(4)}`;
                const interpretation = `A Pearson product-moment correlation was run to assess the relationship between the two variables. The analysis showed a ${getCorrelationStrength(r)} linear relationship between the variables, which was ${isSig ? 'statistically significant' : 'not statistically significant'}, r(${n-2}) = ${r.toFixed(4)}, p = ${p.toFixed(4)}. ${isSig ? `This means that there is a reliable linear association between the two variables; as one variable changes, the other changes in a predictable, linear fashion.` : `This means that there is no reliable evidence of a linear association between the two variables.`}`;
                const recommendations = `1. Create a scatterplot of the two variables to visually confirm the relationship is linear and to check for outliers.\n2. If the relationship does not appear linear or the data is ordinal, consider using the 'Spearman Correlation' instead.`;
                return { title: "Pearson Correlation", results, interpretation, recommendations };
            }

            function runSpearman() {
                const var1 = getNumericColumn(document.getElementById('var1').value);
                const var2 = getNumericColumn(document.getElementById('var2').value);
                if (var1.length !== var2.length || var1.length < 3) throw new Error('Variables must have same number of valid data points (min 3).');
                const r1 = rankData(var1);
                const r2 = rankData(var2);
                const rho = ss.sampleCorrelation(r1, r2);
                const results = `rho = ${rho.toFixed(4)}\n`+
                       `(Note: p-value calculation for Spearman is complex and not provided here).`;
                const interpretation = `A Spearman's rank-order correlation was run to assess the relationship between the two variables. The analysis revealed a ${getCorrelationStrength(rho)} monotonic relationship, rho = ${rho.toFixed(4)}. This result suggests that as the rank of one variable increases, the rank of the other variable tends to consistently increase (or decrease). This test is useful for non-linear but monotonic relationships or ordinal data.`;
                const recommendations = `Create a scatterplot to visualize the relationship. This test is a non-parametric alternative to Pearson's correlation and is suitable for ordinal data or when the assumption of a linear relationship is not met.`;
                return { title: "Spearman Correlation", results, interpretation, recommendations };
            }

            function runChiSquare() {
                const catVar1Name = document.getElementById('cat-var1').value;
                const catVar2Name = document.getElementById('cat-var2').value;
                const cat1Levels = [...new Set(getColumn(catVar1Name))];
                const cat2Levels = [...new Set(getColumn(catVar2Name))];
                const contingencyTable = cat1Levels.map(() => cat2Levels.map(() => 0));
                for (const row of appState.data) {
                    const idx1 = cat1Levels.indexOf(row[catVar1Name]);
                    const idx2 = cat2Levels.indexOf(row[catVar2Name]);
                    if (idx1 > -1 && idx2 > -1) contingencyTable[idx1][idx2]++;
                }
                const rowTotals = contingencyTable.map(row => row.reduce((a, b) => a + b, 0));
                const colTotals = cat2Levels.map((_, i) => contingencyTable.reduce((acc, row) => acc + row[i], 0));
                const grandTotal = rowTotals.reduce((a, b) => a + b, 0);
                if (grandTotal === 0) throw new Error("No overlapping data found for the selected variables.");
                let chi2 = 0;
                for (let i = 0; i < cat1Levels.length; i++) {
                    for (let j = 0; j < cat2Levels.length; j++) {
                        const expected = (rowTotals[i] * colTotals[j]) / grandTotal;
                        if (expected === 0) continue;
                        chi2 += Math.pow(contingencyTable[i][j] - expected, 2) / expected;
                    }
                }
                const df = (cat1Levels.length - 1) * (cat2Levels.length - 1);
                const p = 1 - jStat.chisquare.cdf(chi2, df);
                const isSig = p < 0.05;
                const results = `Chi-Square (χ²) = ${chi2.toFixed(4)}\n` +
                       `Degrees of freedom = ${df}\n` +
                       `p-value = ${p.toFixed(4)}`;
                const interpretation = `A chi-square test of independence was performed to examine the relationship between the two categorical variables. The relationship between these variables was found to be ${isSig ? 'statistically significant' : 'not statistically significant'}, χ²(${df}, N = ${grandTotal}) = ${chi2.toFixed(4)}, p = ${p.toFixed(4)}. ${isSig ? 'This result indicates that there is a reliable association between the two variables. In other words, the category an individual falls into on the first variable is related to the category they fall into on the second variable.' : 'This result suggests that there is no reliable association between the two variables; they appear to be independent.'}`;
                const recommendations = isSig ? `Examine the contingency table (observed counts vs. expected counts) to understand the nature of the relationship. Calculating percentages within your groups can help clarify the association.` : `There is no evidence of a statistical association between these two variables.`;
                return { title: "Chi-Square Test of Independence", results, interpretation, recommendations };
            }
            
            function runSimpleRegression() {
                const ivName = document.getElementById('iv-var').value;
                const dvName = document.getElementById('dv-var').value;
                const ivVar = getNumericColumn(ivName);
                const dvVar = getNumericColumn(dvName);
                if (ivVar.length !== dvVar.length || ivVar.length < 2) throw new Error("Independent and Dependent variables must have the same number of valid data points.");
                const dataPairs = ivVar.map((iv, i) => [iv, dvVar[i]]);
                const { m, b } = ss.linearRegression(dataPairs);
                const r2 = ss.rSquared(dataPairs, (x) => m * x + b);
                const results = `Regression Equation: ${dvName} = ${m.toFixed(4)} * ${ivName} + ${b.toFixed(4)}\n` +
                       `R-squared (R²) = ${r2.toFixed(4)}`;
                const interpretation = `A simple linear regression was calculated to predict the dependent variable based on the independent variable. A significant regression equation was found (p-value must be checked in a full statistical package), explaining ${(r2 * 100).toFixed(2)}% of the variance in the outcome (R² = ${r2.toFixed(4)}). This means that the independent variable, ${ivName}, significantly predicts the dependent variable, ${dvName}. For every one-unit increase in ${ivName}, the model predicts an ${m >= 0 ? 'increase' : 'decrease'} of ${Math.abs(m).toFixed(4)} units in ${dvName}.`;
                const recommendations = `1. Create a scatterplot to visually check the linearity assumption.\n2. In a full statistical package, you should examine the residuals to check for other assumptions like homoscedasticity.\n3. To predict an outcome from multiple variables, use 'Multiple Linear Regression'.`;
                return { title: "Simple Linear Regression", results, interpretation, recommendations };
            }

            function runMultipleRegression() {
                const dvName = document.getElementById('dv-var').value;
                const ivSelect = document.getElementById('iv-vars');
                const ivNames = [...ivSelect.selectedOptions].map(opt => opt.value);
                const columns = [dvName, ...ivNames];
                const dataForRegression = appState.data.map(row => {
                    const dataPoint = [];
                    for (const col of columns) {
                        const val = parseFloat(row[col]);
                        if (isNaN(val)) return null;
                        dataPoint.push(val);
                    }
                    return [...dataPoint.slice(1), dataPoint[0]];
                }).filter(row => row !== null);
                if (dataForRegression.length < ivNames.length + 2) throw new Error("Not enough complete cases for the number of variables selected.");
                const result = regression.linear(dataForRegression, { precision: 4 });
                const equation = result.string;
                const r2 = result.r2;
                const results = `Regression Equation: ${equation}\n` +
                       `R-squared (R²) = ${r2.toFixed(4)}`;
                const interpretation = `A multiple linear regression was calculated to predict the dependent variable based on the set of independent variables. The overall model explained ${(r2 * 100).toFixed(2)}% of the variance in the outcome (R² = ${r2.toFixed(4)}). In simpler terms, the combination of predictor variables has a statistically significant effect on the outcome variable (model significance must be verified in a full statistical package). Each predictor's coefficient in the equation indicates its unique contribution; for example, a one-unit increase in one predictor is associated with a change in the outcome equal to its coefficient, assuming all other predictors are held constant.`;
                const recommendations = `This tool provides the overall model. Use the Python code guide to get the full output, which includes the statistical significance (p-value) for each individual predictor variable. This is crucial for knowing which variables are important. Also, check for multicollinearity among predictors.`;
                return { title: "Multiple Linear Regression", results, interpretation, recommendations };
            }

            function runLogisticRegression() {
                const dvName = document.getElementById('dv-var').value;
                const ivSelect = document.getElementById('iv-vars');
                const ivNames = [...ivSelect.selectedOptions].map(opt => opt.value);

                // 1. Prepare and validate data
                const rawFeatures = [];
                const labels = [];
                appState.data.forEach(row => {
                    const dvVal = parseFloat(row[dvName]);
                    if (isNaN(dvVal)) return; // Skip rows with invalid DV

                    const featureRow = [];
                    let rowIsValid = true;
                    for (const col of ivNames) {
                        const val = parseFloat(row[col]);
                        if (isNaN(val)) {
                            rowIsValid = false;
                            break;
                        }
                        featureRow.push(val);
                    }
                    if (rowIsValid) {
                        rawFeatures.push(featureRow);
                        labels.push(dvVal);
                    }
                });

                const isBinary = labels.every(v => v === 0 || v === 1);
                if (!isBinary) {
                    throw new Error(`The dependent variable for Logistic Regression must be binary (0s and 1s). After cleaning, "${dvName}" contains other values.`);
                }
                if (rawFeatures.length < ivNames.length + 2) {
                    throw new Error("Not enough complete cases for the number of variables selected.");
                }

                // 2. Feature Scaling (Standardization) for better convergence
                const means = [];
                const stdDevs = [];
                for (let j = 0; j < ivNames.length; j++) {
                    const col = rawFeatures.map(row => row[j]);
                    const mean = ss.mean(col);
                    const stdDev = ss.standardDeviation(col);
                    means.push(mean);
                    stdDevs.push(stdDev === 0 ? 1 : stdDev); // Avoid division by zero
                }
                const features = rawFeatures.map(row => {
                    const scaledRow = row.map((val, j) => (val - means[j]) / stdDevs[j]);
                    return [1, ...scaledRow]; // Add intercept term (x0 = 1)
                });
                
                // 3. Self-contained Logistic Regression implementation using Gradient Descent
                const sigmoid = (z) => 1 / (1 + Math.exp(-z));
                const dot = (a, b) => a.map((x, i) => a[i] * b[i]).reduce((m, n) => m + n);

                const train = (X, y, iterations, learningRate) => {
                    let weights = new Array(X[0].length).fill(0);
                    const m = X.length;
                    for (let i = 0; i < iterations; i++) {
                        const predictions = X.map(row => sigmoid(dot(row, weights)));
                        const errors = predictions.map((p, j) => p - y[j]);
                        const gradient = weights.map((_, k) => (1 / m) * X.reduce((acc, row, j) => acc + errors[j] * row[k], 0));
                        weights = weights.map((w, k) => w - learningRate * gradient[k]);
                    }
                    return weights;
                };

                // 4. Run training and get scaled weights
                const trainedWeights = train(features, labels, 1000, 0.1);

                // 5. Un-scale weights to make them interpretable with original data units
                const unscaledCoefficients = trainedWeights.slice(1).map((w, i) => w / stdDevs[i]);
                let unscaledIntercept = trainedWeights[0];
                for (let i = 0; i < unscaledCoefficients.length; i++) {
                    unscaledIntercept -= unscaledCoefficients[i] * means[i];
                }

                if (isNaN(unscaledIntercept) || unscaledCoefficients.some(isNaN)) {
                    throw new Error("Model training resulted in non-numeric coefficients. This can happen with highly collinear data or features with zero variance. Please check your data.");
                }

                // 6. Format the output
                const equation = `log(p/(1-p)) = ${unscaledIntercept.toFixed(4)} + ${unscaledCoefficients.map((c, i) => `${c.toFixed(4)}*${ivNames[i]}`).join(' + ')}`;
                const results = `Coefficients:\n` +
                               `  - Intercept: ${unscaledIntercept.toFixed(4)}\n` +
                               ivNames.map((name, i) => `  - ${name}: ${unscaledCoefficients[i].toFixed(4)}`).join('\n') +
                               `\n\nEquation (Log-Odds):\n${equation}`;
                
                const interpretation = `A logistic regression was performed to ascertain the effects of the independent variable(s) on the likelihood that the binary outcome occurs. The coefficients in the log-odds equation can be interpreted using odds ratios (by calculating e^coefficient). An odds ratio greater than 1 suggests a positive association with the outcome (coded as 1), while an odds ratio less than 1 suggests a negative association. For example, for the predictor "${ivNames[0]}", the odds ratio is ${Math.exp(unscaledCoefficients[0]).toFixed(4)}.`;
                const recommendations = `This statistical tool provides the model coefficients. For a complete analysis, use a full statistical package (like the provided Python code) to obtain model fit statistics (e.g., AIC, Pseudo R-squared) and significance tests for each coefficient. This is essential for evaluating your model's performance and the importance of each predictor.`;

                return { title: "Logistic Regression", results, interpretation, recommendations };
            }
            
            function runModeration() {
                const dvName = document.getElementById('dv-var').value;
                const ivName = document.getElementById('iv-var').value;
                const modName = document.getElementById('mod-var').value;

                if (ivName === modName || ivName === dvName || modName === dvName) {
                    throw new Error("Dependent, Independent, and Moderator variables must all be different.");
                }

                // First pass to get complete cases for calculating means
                const completeCases = appState.data.map(row => {
                    const iv = parseFloat(row[ivName]);
                    const mod = parseFloat(row[modName]);
                    const dv = parseFloat(row[dvName]);
                    if (isNaN(iv) || isNaN(mod) || isNaN(dv)) return null;
                    return { iv, mod, dv };
                }).filter(row => row !== null);

                if (completeCases.length < 4) {
                    throw new Error(`Not enough complete cases for moderation analysis. This test requires at least 4 rows with valid numbers in all selected columns. Your data has only ${completeCases.length} complete rows. Please check for empty cells or non-numeric text in your selected columns.`);
                }

                // Calculate means for centering to reduce multicollinearity
                const meanIv = ss.mean(completeCases.map(r => r.iv));
                const meanMod = ss.mean(completeCases.map(r => r.mod));

                // Second pass to create centered variables and interaction term
                const dataForRegression = completeCases.map(row => {
                    const iv_c = row.iv - meanIv;
                    const mod_c = row.mod - meanMod;
                    const interaction = iv_c * mod_c;
                    return [iv_c, mod_c, interaction, row.dv]; // Centered IV, Centered MOD, INTERACTION, DV
                });

                // Pre-analysis validation for constant columns (zero variance)
                const ivColumn = dataForRegression.map(row => row[0]);
                const modColumn = dataForRegression.map(row => row[1]);
                const interactionColumn = dataForRegression.map(row => row[2]);

                if (ss.variance(ivColumn) === 0) {
                    throw new Error(`The Independent Variable "${ivName}" has no variance (all values are the same). Please select a different variable.`);
                }
                if (ss.variance(modColumn) === 0) {
                    throw new Error(`The Moderator Variable "${modName}" has no variance (all values are the same). Please select a different variable.`);
                }
                if (ss.variance(interactionColumn) === 0) {
                    throw new Error(`The interaction term ("${ivName}" * "${modName}") has no variance. This can happen with certain data patterns (e.g., if one variable is always zero when the other is not). Please check your data or variable selection.`);
                }

                let result;
                try {
                    result = regression.linear(dataForRegression, { precision: 4 });
                } catch (err) {
                    throw new Error(`Regression calculation failed. This often happens due to data issues like perfect multicollinearity. Original error: ${err.message}`);
                }

                if (!result || !result.equation || result.equation.length < 4) {
                    throw new Error("Regression analysis returned an invalid result. Even after mean-centering the predictors, the model could not be computed. Please check your data for other issues, such as a perfect correlation between your IV and Moderator.");
                }
                
                const r2 = result.r2;
                const coeffs = result.equation;
                
                const ivName_c = `${ivName}_centered`;
                const modName_c = `${modName}_centered`;
                const equation = `Y = ${coeffs[3].toFixed(4)} + ${coeffs[0].toFixed(4)}*${ivName_c} + ${coeffs[1].toFixed(4)}*${modName_c} + ${coeffs[2].toFixed(4)}*(${ivName_c}*${modName_c})`;

                const results = `Model R-squared (R²) = ${r2.toFixed(4)}\n\n` +
                       `NOTE: IV and Moderator were mean-centered to improve model stability.\n\n` +
                       `Equation (with centered predictors):\n${equation}\n\n`+
                       `Coefficients:\n`+
                       `  - Intercept: ${coeffs[3].toFixed(4)}\n`+
                       `  - ${ivName_c}: ${coeffs[0].toFixed(4)}\n`+
                       `  - ${modName_c}: ${coeffs[1].toFixed(4)}\n`+
                       `  - Interaction: ${coeffs[2].toFixed(4)}`;
                const interpretation = `A moderation analysis was conducted using linear regression to determine if the relationship between the independent variable (X) and the dependent variable (Y) was moderated by a third variable (Z). The key finding in this analysis is the interaction term. The coefficient for this term is ${coeffs[2].toFixed(4)}. If this coefficient is found to be statistically significant (p < .05, from a full statistical package), it would indicate a significant moderation effect. This would mean that the effect of the independent variable on the dependent variable changes depending on the level of the moderator.`;
                const recommendations = `Use the Python code guide to get the full regression summary, which will provide the p-value for the interaction term. If the interaction is significant, the next step is to perform a simple slopes analysis to explore and visualize how the relationship between X and Y changes at different levels of the moderator Z.`;
                return { title: "Moderation Analysis", results, interpretation, recommendations };
            }

            // --- Functions for Visualization Tool ---

            function generateAnalysisRecommendations() {
                const container = document.getElementById('analysis-recommendation-container');
                const output = document.getElementById('analysis-recommendation');
                if (!appState.headers || appState.headers.length === 0) {
                    container.classList.add('hidden');
                    return;
                }

                const columnTypes = appState.headers.map(h => ({ name: h, type: getColumnType(h) }));
                const numericCols = columnTypes.filter(c => c.type === 'numeric').map(c => c.name);
                const categoricalCols = columnTypes.filter(c => c.type === 'categorical').map(c => c.name);
                
                let recommendations = [];

                if (numericCols.length === 1) {
                     recommendations.push(`<strong>Descriptive Statistics</strong>: Use for a single numeric variable like <strong>${numericCols[0]}</strong> to understand its basic properties.`);
                }
                
                if (numericCols.length >= 2) {
                    recommendations.push(`<strong>Pearson Correlation / Simple Linear Regression</strong>: Use to test the relationship between two numeric variables (e.g., <strong>${numericCols[0]}</strong> and <strong>${numericCols[1]}</strong>) or predict one from the other.`);
                    recommendations.push(`<strong>Multiple Linear Regression</strong>: Appropriate when you have multiple numeric predictors and one numeric outcome.`);
                    recommendations.push(`<strong>Cronbach's Alpha</strong>: Use to measure the internal consistency of your numeric scale items.`);
                }
                
                if (categoricalCols.length === 1 && numericCols.length >= 1) {
                    recommendations.push(`<strong>Independent Samples t-test</strong>: Use to compare the mean of a numeric variable (e.g., <strong>${numericCols[0]}</strong>) between two groups in a categorical variable (e.g., <strong>${categoricalCols[0]}</strong>).`);
                     recommendations.push(`<strong>One-Way ANOVA</strong>: Use to compare means of a numeric variable across three or more groups.`);
                }
               
                if (categoricalCols.length >= 2) {
                     recommendations.push(`<strong>Chi-Square Test</strong>: Use to see if two categorical variables (e.g., <strong>${categoricalCols[0]}</strong> and <strong>${categoricalCols[1]}</strong>) are associated.`);
                     if (numericCols.length >= 1) {
                        recommendations.push(`<strong>Factorial ANOVA</strong>: Use to examine how two categorical variables (e.g., <strong>${categoricalCols[0]}</strong> and <strong>${categoricalCols[1]}</strong>) affect a numeric outcome.`);
                     }
                }

                if (recommendations.length > 0) {
                    output.innerHTML = '<ul>' + recommendations.map(r => `<li class="mb-2">&#8227; ${r}</li>`).join('') + '</ul>';
                    container.classList.remove('hidden');
                } else {
                    output.innerHTML = '<p>Could not automatically determine a recommendation. Please select a test manually based on your research question.</p>';
                    container.classList.remove('hidden');
                }
            }

            function getColumnType(columnName) {
                const columnData = getColumn(columnName).slice(0, 100); // Sample first 100 non-null values
                if (columnData.length === 0) return 'empty';
                let numericCount = 0;
                const uniqueValues = new Set();
                
                columnData.forEach(val => {
                    if (typeof val === 'string') val = val.trim();
                    if (val !== '' && !isNaN(Number(val)) && val !== null) {
                        numericCount++;
                    }
                    uniqueValues.add(val);
                });

                const numericRatio = numericCount / columnData.length;
                
                if (numericRatio > 0.9) return 'numeric';
                if (uniqueValues.size <= 15 || (columnData.length > 0 && uniqueValues.size / columnData.length < 0.5)) return 'categorical';
                
                return 'mixed-text';
            }

            function generateChartRecommendations() {
                const container = document.getElementById('vis-recommendation-container');
                const output = document.getElementById('vis-recommendation');
                if (!appState.headers || appState.headers.length === 0) {
                    container.classList.add('hidden');
                    return;
                }

                const columnTypes = appState.headers.map(h => ({ name: h, type: getColumnType(h) }));
                const numericCols = columnTypes.filter(c => c.type === 'numeric').map(c => c.name);
                const categoricalCols = columnTypes.filter(c => c.type === 'categorical').map(c => c.name);
                
                let recommendations = [];

                // Re-ordered and refined for clarity and relevance
                if (numericCols.length === 1 && categoricalCols.length === 0) {
                    recommendations.push(`<strong>Histogram / Density Plot</strong>: Best for visualizing the distribution of a single numeric variable like <strong>${numericCols[0]}</strong>.`);
                }
                
                if (categoricalCols.length === 1 && numericCols.length === 0) {
                    recommendations.push(`<strong>Bar Chart</strong>: Use to show the frequency of each category in a single categorical variable like <strong>${categoricalCols[0]}</strong>.`);
                }
                
                if (numericCols.length >= 2) {
                    recommendations.push(`<strong>Scatter Plot</strong>: The best way to see the relationship between two numeric variables (e.g., <strong>${numericCols[0]}</strong> and <strong>${numericCols[1]}</strong>).`);
                }
                
                if (categoricalCols.length >= 1 && numericCols.length >= 1) {
                    recommendations.push(`<strong>Boxplot / Violin Plot</strong>: Most informative for comparing the distribution of a numeric variable (e.g., <strong>${numericCols[0]}</strong>) across groups in <strong>${categoricalCols[0]}</strong>. A <strong>Bar Chart</strong> is also good for comparing means.`);
                }
               
                if (categoricalCols.length >= 2) {
                     recommendations.push(`<strong>Mosaic Plot</strong>: Use to visualize the relationship and proportions between two categorical variables, such as <strong>${categoricalCols[0]}</strong> and <strong>${categoricalCols[1]}</strong>.`);
                }

                if (numericCols.length > 2) {
                    recommendations.push(`<strong>Heatmap</strong>: Excellent for visualizing the correlations of multiple numeric variables at a glance.`);
                }

                if (recommendations.length > 0) {
                    output.innerHTML = '<ul>' + recommendations.map(r => `<li class="mb-2">&#8227; ${r}</li>`).join('') + '</ul>';
                    container.classList.remove('hidden');
                } else {
                    output.innerHTML = '<p>Could not automatically determine a recommendation. Please select a chart manually based on your research question.</p>';
                    container.classList.remove('hidden');
                }
            }


            function handleVisFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    visualizationOutput.innerHTML = `<p>Processing "${file.name}"...</p>`;
                    try {
                        const fileExtension = file.name.split('.').pop().toLowerCase();
                        if (fileExtension === 'csv') {
                            parseCsvForVis(e.target.result, file.name);
                        } else if (['xlsx', 'xls'].includes(fileExtension)) {
                            parseExcelForVis(e.target.result, file.name);
                        } else {
                            throw new Error('Unsupported file type. Please upload a CSV or Excel file.');
                        }
                    } catch (error) {
                        handleVisError(`Error processing file: ${error.message}`);
                    }
                };
                reader.onerror = () => handleVisError('Error reading file.');

                if (['xlsx', 'xls'].includes(file.name.split('.').pop().toLowerCase())) {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            }

            function parseCsvForVis(csvString, fileName){
                Papa.parse(csvString, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length) {
                            throw new Error(results.errors[0].message);
                        }
                        processParsedDataForVis(results.data, results.meta.fields, fileName);
                    }
                });
            }

            function parseExcelForVis(data, fileName){
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
                const headers = jsonData.length > 0 ? Object.keys(jsonData[0]) : [];
                processParsedDataForVis(jsonData, headers, fileName);
            }

            function processParsedDataForVis(data, headers, fileName) {
                appState.data = data;
                appState.headers = headers;
                visualizationOutput.innerHTML = `<p>File "${fileName}" loaded. Found ${data.length} rows and ${headers.length} columns. Please select a visualization.</p>`;
                visualizationControls.classList.remove('hidden');
                chartSelector.value = "";
                visColumnSelectorContainer.innerHTML = '';
                runVisualizationBtn.disabled = true;
                displayPreviewForVis(data, headers);
                generateChartRecommendations();
            }

            function handleVisError(message) {
                visualizationOutput.innerHTML = `<p class="text-red-400 font-semibold">${message}</p>`;
                visualizationControls.classList.add('hidden');
                appState.data = null;
                appState.headers = [];
            }

            function displayPreviewForVis(data, headers) {
                const previewData = data.slice(0, 5);
                let tableHTML = '<thead><tr class="bg-stone-700">';
                headers.forEach(h => tableHTML += `<th class="p-2 font-semibold">${h}</th>`);
                tableHTML += '</tr></thead><tbody>';
                previewData.forEach(row => {
                    tableHTML += '<tr class="border-b border-stone-700">';
                    headers.forEach(h => tableHTML += `<td class="p-2">${row[h] === null ? 'NA' : row[h]}</td>`);
                    tableHTML += '</tr>';
                });
                visPreviewTable.innerHTML = tableHTML + '</tbody>';
            }

            function updateVisColumnSelectors() {
                const chart = chartSelector.value;
                visColumnSelectorContainer.innerHTML = '';
                runVisualizationBtn.disabled = true;
                if (!chart || !appState.headers.length) return;

                let selectorsHTML = '';
                const baseHelpText = (text) => `<p class="text-sm text-stone-400 mb-2">${text}</p>`;
                const oneNumVar = (label = 'Variable (Numeric)') => baseHelpText('Requires one numerical variable.') + createSelectHTML('vis-var1', label, appState.headers);
                const twoNumVars = (xLabel = 'X-Axis Variable', yLabel = 'Y-Axis Variable') => baseHelpText('Requires two numerical variables.') + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${createSelectHTML('vis-varX', xLabel, appState.headers)}${createSelectHTML('vis-varY', yLabel, appState.headers)}</div>`;
                const threeNumVars = (xLabel = 'X-Axis', yLabel = 'Y-Axis', zLabel = 'Size Variable') => baseHelpText('Requires three numerical variables.') + `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">${createSelectHTML('vis-varX', xLabel, appState.headers)}${createSelectHTML('vis-varY', yLabel, appState.headers)}${createSelectHTML('vis-varZ', zLabel, appState.headers)}</div>`;
                const twoCatVars = (cat1 = 'Categorical Variable 1', cat2 = 'Categorical Variable 2') => baseHelpText('Requires two categorical variables.') + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${createSelectHTML('vis-cat1', cat1, appState.headers)}${createSelectHTML('vis-cat2', cat2, appState.headers)}</div>`;
                const oneCatOneNum = (catLabel = 'Categorical Variable', numLabel = 'Numerical Variable') => baseHelpText('Requires one categorical and one numerical variable.') + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${createSelectHTML('vis-varCat', catLabel, appState.headers)}${createSelectHTML('vis-varNum', numLabel, appState.headers)}</div>`;
                const multiNumVars = (label = 'Variables', min = 2) => baseHelpText(`Select ${min} or more numerical variables. (Hold Ctrl/Cmd to select multiple)`) + createSelectHTML('vis-vars-multi', label, appState.headers, true);
                const complexChartMessage = (chartName, requirements) => baseHelpText(`<strong>${chartName}</strong> is a complex visualization. ${requirements} This tool provides the variable selectors, but for full customization and generation, using a dedicated Python library (as shown in the reference guides) is recommended.`);

                switch(chart) {
                    // Distributions
                    case 'histogram':
                    case 'density_plot':
                        selectorsHTML = oneNumVar();
                        break;
                    case 'boxplot':
                    case 'violin_plot':
                        selectorsHTML = baseHelpText('Select one numerical variable for a single plot, or one categorical and one numerical for a comparison plot.') +
                            `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${createSelectHTML('vis-varCat', 'Categorical Variable (Optional)', appState.headers, false, true)}${createSelectHTML('vis-varNum', 'Numerical Variable', appState.headers)}</div>`;
                        break;
                    case 'qq_plot':
                        selectorsHTML = oneNumVar('Variable to check against normal distribution');
                        break;
                    case 'ridgeline_plot':
                         selectorsHTML = complexChartMessage('Ridgeline Plot', 'Usually requires a numerical variable and a categorical variable to create the overlapping densities.') + oneCatOneNum();
                        break;

                    // Relationships & Comparisons
                    case 'scatter_plot':
                    case 'line_chart':
                    case 'area_chart':
                        selectorsHTML = twoNumVars();
                        break;
                    case 'bar_chart':
                    case 'dot_plot':
                         selectorsHTML = oneCatOneNum('Categorical Variable (X-Axis)', 'Numerical Variable (Y-Axis)');
                        break;
                    case 'bubble_chart':
                        selectorsHTML = threeNumVars('X-Axis Variable', 'Y-Axis Variable', 'Bubble Size Variable');
                        break;

                    // Correlations & Matrix
                    case 'heatmap':
                    case 'correlogram':
                         selectorsHTML = multiNumVars('Variables for Correlation Matrix', 2);
                         break;
                    
                    // Part-to-Whole
                    case 'pie_chart':
                         selectorsHTML = oneCatOneNum('Categories', 'Values');
                         break;
                    case 'mosaic_plot':
                         selectorsHTML = twoCatVars();
                        break;
                    case 'pareto_chart':
                         selectorsHTML = complexChartMessage('Pareto Chart', 'Requires a categorical variable for the bars and a numerical variable for their counts/values.') + oneCatOneNum();
                         break;
                    case 'treemap':
                    case 'sunburst_chart':
                        selectorsHTML = complexChartMessage(chart.replace(/_/g, ' '), 'Requires hierarchical data, often with labels, parent categories, and values.')
                        break;
                    
                    // Flow & Networks
                    case 'sankey_diagram':
                    case 'network_graph':
                    case 'funnel_chart':
                        selectorsHTML = complexChartMessage(chart.replace(/_/g, ' '), 'Requires specific data structures (e.g., source-target-value for Sankey, nodes-edges for Network).');
                        break;
                    
                    // Specialized & Statistical
                    case 'forest_plot':
                        selectorsHTML = complexChartMessage('Forest Plot', 'Requires columns for study labels, effect sizes, and standard errors.') +
                            `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">${createSelectHTML('vis-labels', 'Study Labels', appState.headers)}${createSelectHTML('vis-effect', 'Effect Sizes', appState.headers)}${createSelectHTML('vis-se', 'Standard Errors', appState.headers)}</div>`;
                        break;
                    case 'kaplan_meier_curve':
                        selectorsHTML = complexChartMessage('Kaplan-Meier Curve', 'Requires a time-to-event duration column and a status column indicating if the event occurred (e.g., 1 for event, 0 for censored).') + twoNumVars('Time-to-Event', 'Event Status');
                        break;
                    case 'roc_curve':
                        selectorsHTML = complexChartMessage('ROC Curve', 'Requires a column of true binary outcomes (0/1) and a column of predicted probabilities for the positive class.') + twoNumVars('True Labels (0/1)', 'Predicted Probabilities');
                        break;
                        
                    default:
                        selectorsHTML = '<p class="text-stone-400">Please select a chart type to see variable options.</p>';
                }
                visColumnSelectorContainer.innerHTML = selectorsHTML;
                visColumnSelectorContainer.querySelectorAll('select').forEach(sel => sel.addEventListener('change', checkVisRunButtonState));
            }

            function checkVisRunButtonState() {
                const selects = [...visColumnSelectorContainer.querySelectorAll('select')];
                const allRequiredSelected = selects.every(sel => {
                    if (sel.dataset.optional === 'true') {
                        return true; // Optional selectors don't block the button
                    }
                    if (sel.multiple) {
                        return sel.selectedOptions.length > 0;
                    }
                    return sel.value !== ''; // Required selectors must have a value
                });
                runVisualizationBtn.disabled = !allRequiredSelected;
            }

            function runVisualization() {
                const chart = chartSelector.value;
                visualizationOutput.innerHTML = '<p class="text-center pt-16 text-stone-400">Generating Chart...</p>'; // Clear previous chart and show loading message
                visualizationOutput.classList.add('loading');

                        const getPlotlyLayout = (title, xaxis_title = '', yaxis_title = '') => {
                    const facebookBlue = '#1877F2';
                    return {
                        title: { text: title, font: { color: facebookBlue, size: 18 } },
                        font: { color: '#1f2937', family: 'sans-serif' }, // gray-800
                        paper_bgcolor: 'transparent',
                        plot_bgcolor: '#f9fafb', // gray-50
                        xaxis: { 
                            title: xaxis_title,
                            gridcolor: '#e5e7eb', // gray-200
                            zerolinecolor: '#d1d5db', // gray-300
                            linecolor: '#d1d5db' // gray-300
                        },
                        yaxis: { 
                            title: yaxis_title,
                            gridcolor: '#e5e7eb', // gray-200
                            zerolinecolor: '#d1d5db', // gray-300
                            linecolor: '#d1d5db' // gray-300
                        },
                        legend: { bgcolor: 'rgba(255, 255, 255, 0.8)', bordercolor: '#e5e7eb', borderwidth: 1 },
                        margin: { l: 60, r: 30, b: 50, t: 50, pad: 4 }
                    };
                };

                // Use a timeout to allow the "Generating..." message to render
                setTimeout(() => {
                    try {
                        let plotData = [];
                        let plotLayout = {};

                        switch (chart) {
                            case 'histogram': {
                                const varName = document.getElementById('vis-var1').value;
                                const data = getNumericColumn(varName);
                                if (data.length === 0) throw new Error(`Column "${varName}" has no numeric data.`);
                                
                                plotData = [{
                                    x: data,
                                    type: 'histogram',
                                    marker: { color: '#1877F2' }
                                }];
                                plotLayout = getPlotlyLayout(`Distribution of ${varName}`, varName, 'Frequency');
                                break;
                            }

                            case 'density_plot': {
                                const varName = document.getElementById('vis-var1').value;
                                const data = getNumericColumn(varName);
                                if (data.length === 0) throw new Error(`Column "${varName}" has no numeric data.`);
                                
                                plotData = [{
                                    y: data,
                                    type: 'violin',
                                    box: { visible: false },
                                    meanline: { visible: true },
                                    points: false,
                                    line: { color: '#1877F2' },
                                    name: varName
                                }];
                                plotLayout = getPlotlyLayout(`Density of ${varName}`, '', varName);
                                plotLayout.yaxis.zeroline = false;
                                break;
                            }

                            case 'scatter_plot': {
                                const xVar = document.getElementById('vis-varX').value;
                                const yVar = document.getElementById('vis-varY').value;
                                const xData = getNumericColumn(xVar);
                                const yData = getNumericColumn(yVar);
                                const combined = xData.map((x, i) => ({x, y: yData[i]})).filter(p => p.x != null && p.y != null);
                                if (combined.length === 0) throw new Error("No valid data pairs found for the selected variables.");

                                plotData = [{
                                    x: combined.map(p => p.x),
                                    y: combined.map(p => p.y),
                                    mode: 'markers',
                                    type: 'scatter',
                                    marker: { color: '#1877F2', size: 8, opacity: 0.7 }
                                }];
                                plotLayout = getPlotlyLayout(`${yVar} vs. ${xVar}`, xVar, yVar);
                                break;
                            }

                             case 'bar_chart': {
                                const catVar = document.getElementById('vis-varCat').value;
                                const numVar = document.getElementById('vis-varNum').value;
                                
                                const groupedData = {};
                                appState.data.forEach(row => {
                                    const cat = row[catVar];
                                    const num = parseFloat(row[numVar]);
                                    if (cat != null && !isNaN(num)) {
                                        if (!groupedData[cat]) groupedData[cat] = [];
                                        groupedData[cat].push(num);
                                    }
                                });

                                const categories = Object.keys(groupedData);
                                if (categories.length === 0) throw new Error("No valid data found to create bar chart.");
                                const means = categories.map(cat => ss.mean(groupedData[cat]));

                                plotData = [{
                                    x: categories,
                                    y: means,
                                    type: 'bar',
                                    marker: { color: '#1877F2' }
                                }];
                                plotLayout = getPlotlyLayout(`Mean of ${numVar} by ${catVar}`, catVar, `Mean ${numVar}`);
                                break;
                            }
                            
                            case 'boxplot': {
                                const numVar = document.getElementById('vis-varNum').value;
                                const catVarSelect = document.getElementById('vis-varCat');
                                const catVar = catVarSelect ? catVarSelect.value : null;

                                if (catVar) { // Grouped boxplot
                                    const groupedData = {};
                                    appState.data.forEach(row => {
                                        const cat = row[catVar];
                                        const num = parseFloat(row[numVar]);
                                        if (cat != null && !isNaN(num)) {
                                            if (!groupedData[cat]) groupedData[cat] = [];
                                            groupedData[cat].push(num);
                                        }
                                    });
                                    plotData = Object.keys(groupedData).map(cat => ({
                                        y: groupedData[cat],
                                        type: 'box',
                                        name: cat
                                    }));
                                    plotLayout = getPlotlyLayout(`Distribution of ${numVar} by ${catVar}`, catVar, numVar);

                                } else { // Single boxplot
                                    const data = getNumericColumn(numVar);
                                    if (data.length === 0) throw new Error(`Column "${numVar}" has no numeric data.`);
                                    plotData = [{
                                        y: data,
                                        type: 'box',
                                        name: numVar,
                                        marker: { color: '#1877F2' }
                                    }];
                                    plotLayout = getPlotlyLayout(`Distribution of ${numVar}`, '', numVar);
                                }
                                break;
                            }

                            case 'violin_plot': {
                                const numVar = document.getElementById('vis-varNum').value;
                                const catVarSelect = document.getElementById('vis-varCat');
                                const catVar = catVarSelect ? catVarSelect.value : null;

                                if (catVar) { // Grouped violin
                                    const groupedData = {};
                                     appState.data.forEach(row => {
                                        const cat = row[catVar];
                                        const num = parseFloat(row[numVar]);
                                        if (cat != null && !isNaN(num)) {
                                            if (!groupedData[cat]) groupedData[cat] = [];
                                            groupedData[cat].push(num);
                                        }
                                    });
                                    plotData = Object.keys(groupedData).map(cat => ({
                                        y: groupedData[cat],
                                        type: 'violin',
                                        name: cat,
                                        box: { visible: true },
                                        meanline: { visible: true }
                                    }));
                                    plotLayout = getPlotlyLayout(`Distribution of ${numVar} by ${catVar}`, catVar, numVar);
                                } else { // Single violin
                                    const data = getNumericColumn(numVar);
                                    if (data.length === 0) throw new Error(`Column "${numVar}" has no numeric data.`);
                                    plotData = [{
                                        y: data,
                                        type: 'violin',
                                        name: numVar,
                                        box: { visible: true },
                                        meanline: { visible: true }
                                    }];
                                    plotLayout = getPlotlyLayout(`Distribution of ${numVar}`, '', numVar);
                                }
                                break;
                            }
                            
                            case 'line_chart': {
                                const xVar = document.getElementById('vis-varX').value;
                                const yVar = document.getElementById('vis-varY').value;

                                const sortedData = appState.data
                                    .map(row => ({ x: parseFloat(row[xVar]), y: parseFloat(row[yVar]) }))
                                    .filter(p => !isNaN(p.x) && !isNaN(p.y))
                                    .sort((a, b) => a.x - b.x);
                                
                                if (sortedData.length === 0) throw new Error("No valid data pairs found for the selected variables.");
                                const xData = sortedData.map(p => p.x);
                                const yData = sortedData.map(p => p.y);
                                
                                plotData = [{
                                    x: xData,
                                    y: yData,
                                    mode: 'lines+markers',
                                    type: 'scatter',
                                    line: { color: '#1877F2' }
                                }];
                                plotLayout = getPlotlyLayout(`${yVar} vs. ${xVar}`, xVar, yVar);
                                break;
                            }
                            
                            case 'pie_chart': {
                                const catVar = document.getElementById('vis-varCat').value;
                                const numVar = document.getElementById('vis-varNum').value;
                                
                                const aggregatedData = {};
                                appState.data.forEach(row => {
                                    const cat = row[catVar];
                                    const num = parseFloat(row[numVar]);
                                    if (cat != null && !isNaN(num)) {
                                        if (!aggregatedData[cat]) aggregatedData[cat] = 0;
                                        aggregatedData[cat] += num;
                                    }
                                });

                                const labels = Object.keys(aggregatedData);
                                const values = Object.values(aggregatedData);
                                if (labels.length === 0) throw new Error("No valid data found for pie chart.");

                                plotData = [{
                                    labels: labels,
                                    values: values,
                                    type: 'pie',
                                    hole: .4,
                                    textinfo: 'label+percent',
                                    insidetextorientation: 'radial'
                                }];
                                plotLayout = getPlotlyLayout(`Composition of ${numVar} by ${catVar}`);
                                break;
                            }

                            case 'heatmap': {
                                const itemsSelect = document.getElementById('vis-vars-multi');
                                const selectedItems = [...itemsSelect.selectedOptions].map(opt => opt.value);
                                if (selectedItems.length < 2) throw new Error("Heatmap requires at least two numeric variables.");

                                const numericDataCols = {};
                                selectedItems.forEach(item => numericDataCols[item] = []);
                                
                                appState.data.forEach(row => {
                                    let hasAll = true;
                                    const rowValues = {};
                                    for(const item of selectedItems) {
                                        const val = parseFloat(row[item]);
                                        if(isNaN(val)) {
                                            hasAll = false;
                                            break;
                                        }
                                        rowValues[item] = val;
                                    }
                                    if(hasAll) {
                                        selectedItems.forEach(item => numericDataCols[item].push(rowValues[item]));
                                    }
                                });

                                const correlationMatrix = [];
                                for (let i = 0; i < selectedItems.length; i++) {
                                    const row = [];
                                    for (let j = 0; j < selectedItems.length; j++) {
                                        const item1 = selectedItems[i];
                                        const item2 = selectedItems[j];
                                        if (numericDataCols[item1].length < 2) throw new Error(`Not enough valid data points for column "${item1}" to calculate correlations.`);
                                        const corr = ss.sampleCorrelation(numericDataCols[item1], numericDataCols[item2]);
                                        row.push(corr);
                                    }
                                    correlationMatrix.push(row);
                                }

                                plotData = [{
                                    z: correlationMatrix,
                                    x: selectedItems,
                                    y: selectedItems,
                                    type: 'heatmap',
                                    colorscale: 'Blues',
                                    zmin: -1,
                                    zmax: 1
                                }];
                                plotLayout = getPlotlyLayout('Correlation Heatmap');
                                break;
                            }
                            
                            case 'mosaic_plot': {
                                const catVar1 = document.getElementById('vis-cat1').value;
                                const catVar2 = document.getElementById('vis-cat2').value;
                                if(catVar1 === catVar2) throw new Error("Please select two different categorical variables.");

                                const contingencyTable = {};
                                appState.data.forEach(row => {
                                    const c1 = row[catVar1];
                                    const c2 = row[catVar2];
                                    if (c1 != null && c2 != null) {
                                        if (!contingencyTable[c1]) contingencyTable[c1] = {};
                                        if (!contingencyTable[c1][c2]) contingencyTable[c1][c2] = 0;
                                        contingencyTable[c1][c2]++;
                                    }
                                });
                                
                                const cat1Levels = Object.keys(contingencyTable);
                                if (cat1Levels.length === 0) throw new Error("No valid data found for the selected variables.");
                                
                                const cat2Levels = [...new Set(appState.data.map(r => r[catVar2]).filter(v => v != null))].sort();

                                const cat1Totals = {};
                                cat1Levels.forEach(c1 => {
                                    cat1Totals[c1] = Object.values(contingencyTable[c1]).reduce((a, b) => a + b, 0);
                                });

                                plotData = cat2Levels.map(c2 => {
                                    const yValues = cat1Levels.map(c1 => {
                                        const total = cat1Totals[c1];
                                        const count = contingencyTable[c1][c2] || 0;
                                        return total > 0 ? (count / total) * 100 : 0;
                                    });
                                    return {
                                        x: cat1Levels,
                                        y: yValues,
                                        name: c2,
                                        type: 'bar'
                                    };
                                });

                                plotLayout = getPlotlyLayout(`Proportional Relationship between ${catVar1} and ${catVar2}`, catVar1, `Proportion of ${catVar2} (%)`);
                                plotLayout.barmode = 'stack';
                                plotLayout.yaxis.ticksuffix = '%';
                                break;
                            }


                            default:
                                visualizationOutput.innerHTML = `<p class="text-sky-400">The chart type "${chart.replace(/_/g, ' ')}" is not yet implemented in this tool. Please use a Python library for this visualization.</p>`;
                                return;
                        }

                        if (plotData.length > 0) {
                            Plotly.newPlot('visualization-output', plotData, plotLayout, {responsive: true, displaylogo: false, modeBarButtonsToRemove: ['sendDataToCloud']});
                        }

                    } catch (e) {
                        visualizationOutput.innerHTML = `<p class="text-red-400 font-semibold">Chart Error: ${e.message}</p>`;
                    } finally {
                        visualizationOutput.classList.remove('loading');
                    }
                }, 10);
            }

        });
    </script>
</body>
</html>



























